<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT, OCN.Yang, Android, 杨欧神" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="拼凑江山，只为遇见你时自己不那么不堪">
<meta property="og:type" content="website">
<meta property="og:title" content="杨欧神/OCN.Yang">
<meta property="og:url" content="http://ocnyang.com/page/4/index.html">
<meta property="og:site_name" content="杨欧神/OCN.Yang">
<meta property="og:description" content="拼凑江山，只为遇见你时自己不那么不堪">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="杨欧神/OCN.Yang">
<meta name="twitter:description" content="拼凑江山，只为遇见你时自己不那么不堪">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://ocnyang.com/page/4/"/>





  <title> 杨欧神/OCN.Yang </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?923326cdfba9134256dbbf5887c8ce38";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>










  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">杨欧神/OCN.Yang</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">我问佛：如何让心不再感到孤单？<br>佛曰：每一颗心生来就是孤单而残缺的，多数带着这种残缺度过一生，只因与能使它圆满的另一半相遇时，不是疏忽错过，就是已失去了拥有它的资格</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-circle-o-notch"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-list"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-hourglass-start"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-efall">
          <a href="/categories/还相信爱情/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-key"></i> <br />
            
            menu.efall
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user-secret"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://ocnyang.com/2016/08/22/ListViewAttribute/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="OCN.Yang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/ocnyang.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="杨欧神/OCN.Yang">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/08/22/ListViewAttribute/" itemprop="url">
                  ListView 特殊属性 & 常见问题
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-08-22T16:03:15+08:00">
                2016-08-22
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android控件/" itemprop="url" rel="index">
                    <span itemprop="name">Android控件</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/08/22/ListViewAttribute/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/08/22/ListViewAttribute/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2016/08/22/ListViewAttribute/" class="leancloud_visitors" data-flag-title="ListView 特殊属性 & 常见问题">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="ListView-特殊属性-amp-常见问题"><a href="#ListView-特殊属性-amp-常见问题" class="headerlink" title="ListView 特殊属性 &amp; 常见问题"></a>ListView 特殊属性 &amp; 常见问题</h1><p>这里向大家介绍一些我个人认为比较特别的属性，通过设置这样的属性可以做出更加美观的列表</p>
<h2 id="一-ListView的一些特殊属性"><a href="#一-ListView的一些特殊属性" class="headerlink" title="一.  ListView的一些特殊属性"></a>一.  ListView的一些特殊属性</h2><h3 id="1-stackFromBottom属性"><a href="#1-stackFromBottom属性" class="headerlink" title="1. stackFromBottom属性"></a>1. stackFromBottom属性</h3><p><strong>android:stackFromBottom=”true”</strong>。设置该属性后你做好的列表就会显示你列表的最下面，值为true和false</p>
<h3 id="2-transciptMode属性"><a href="#2-transciptMode属性" class="headerlink" title="2. transciptMode属性"></a>2. transciptMode属性</h3><p>需要用ListView或者其它显示大量Items的控件实时跟踪或者查看信息，并且希望最新的条目可以自动滚动到可视范围内。通过设置的控件transcriptMode属性可以将Android平台的控件（支持ScrollBar）自动滑动到最底部。<br><strong>android:transcriptMode=”alwaysScroll”</strong>   </p>
<h3 id="3-cacheColorHint属性"><a href="#3-cacheColorHint属性" class="headerlink" title="3. cacheColorHint属性"></a>3. cacheColorHint属性</h3><p>很多人希望能够改变一下它的背景，使他能够符合整体的UI设计，改变背景背很简单只需要准备一张图片然后指定属性 <strong>android:background=”@drawable/bg”</strong>，不过不要高兴地太早，当你这么做以后，发现背景是变了，但是当你拖动，或者点击list空白位置的时候发现ListItem都变成黑色的了，破坏了整体效果。<br>如果你只是换背景的颜色的话，可以直接指定 <strong>android:cacheColorHint</strong> 为你所要的颜色，如果你是用图片做背景的话，那也只要将android:cacheColorHint指定为透明（#00000000）就可以了</p>
<h3 id="4-divider属性"><a href="#4-divider属性" class="headerlink" title="4. divider属性"></a>4. divider属性</h3><p>该属性作用是每一项之间需要设置一个图片做为间隔，或是去掉item之间的分割线<br><strong>android:divider=”@drawable/list_driver”</strong>  其中  @drawable/list_driver 是一个图片资源，如果不想显示分割线则只要设置为<strong>android:divider=”@drawable/@null”</strong> 就可以了。<strong>android:dividerHeight=”2dip”</strong> 设置两个item之间的距离</p>
<h3 id="5-headerDividersEnabled属性"><a href="#5-headerDividersEnabled属性" class="headerlink" title="5. headerDividersEnabled属性"></a>5. headerDividersEnabled属性</h3><p><strong>android:headerDividersEnabled=”false”</strong>设成flase时，此ListView将不会在页眉视图前画分隔符。缺省值为true<br><strong>android:footerDividersEnabled</strong> 设成flase时，此ListView将不会在页脚视图前画分隔符。此属性缺省值为true</p>
<h3 id="6-fadingEdge属性"><a href="#6-fadingEdge属性" class="headerlink" title="6. fadingEdge属性"></a>6. fadingEdge属性</h3><p>上边和下边有黑色的阴影(类似边框的东西)<br><strong>android:fadingEdge=”none”</strong> 设置后没有阴影了~</p>
<h3 id="7-scrollbars属性"><a href="#7-scrollbars属性" class="headerlink" title="7. scrollbars属性"></a>7. scrollbars属性</h3><p>作用是隐藏listView的滚动条，<br><strong>android:scrollbars=”none”</strong>与<strong>setVerticalScrollBarEnabled(true)</strong>;的效果是一样的，不活动的时候隐藏，活动的时候也隐藏</p>
<h3 id="8-fadeScrollbars属性"><a href="#8-fadeScrollbars属性" class="headerlink" title="8. fadeScrollbars属性"></a>8. fadeScrollbars属性</h3><p><strong>android:fadeScrollbars=”true”</strong>  配置ListView布局的时候，设置这个属性为true就可以实现滚动条的自动隐藏和显示。</p>
<h3 id="9-fastScrollEnabled属性"><a href="#9-fastScrollEnabled属性" class="headerlink" title="9. fastScrollEnabled属性"></a>9. fastScrollEnabled属性</h3><p>很多开发者不知道ListView列表控件的快速滚动滑块是如何启用的，这里告诉大家，辅助滚动滑块只需要一行代码就可以搞定，如果你使用XML布局只需要在ListView节点中加入  <strong>android:fastScrollEnabled=”true”</strong> 这个属性即可，而对于Java代码可以通过<strong>myListView.setFastScrollEnabled(true)</strong>来控制启用，参数false为隐藏。 还有一点就是当你的滚动内容较小，不到当前ListView的3个屏幕高度时则不会出现这个快速滚动滑块，同时该方法仍然是AbsListView的基础方法，可以在ListView或GridView等子类中使用快速滚动辅助。</p>
<h3 id="10-drawSelectorOnTop属性"><a href="#10-drawSelectorOnTop属性" class="headerlink" title="10. drawSelectorOnTop属性"></a>10. drawSelectorOnTop属性</h3><p><strong>android:drawSelectorOnTop=”true”</strong> 点击某一条记录，颜色会显示在最上面，记录上的文字被遮住，所以点击文字不放，文字就看不到<br><strong>android:drawSelectorOnTop=”false”</strong>点击某条记录不放，颜色会在记录的后面，成为背景色，但是记录内容的文字是可见的</p>
<h3 id="11-listSelector属性"><a href="#11-listSelector属性" class="headerlink" title="11. listSelector属性"></a>11. listSelector属性</h3><p><strong>android:listSelector=”#00000000 “</strong> 改变选中item时的颜色。默认为橙黄底色（依手机系统而定）</p>
<h3 id="12-scrollingCache属性"><a href="#12-scrollingCache属性" class="headerlink" title="12. scrollingCache属性"></a>12. scrollingCache属性</h3><p><strong>android:scrollingCache=”false”</strong>去除拖动时ListView背景为黑色</p>
<h3 id="13-soundEffectsEnabled属性"><a href="#13-soundEffectsEnabled属性" class="headerlink" title="13. soundEffectsEnabled属性"></a>13. soundEffectsEnabled属性</h3><p><strong>android:soundEffectsEnabled=”false”</strong>  点击和触摸时是否有声音效果,缺省值为true(只有系统设置中开启了触摸提示音才有效)</p>
<h2 id="二-解决ListView-item中含有Button或者Checkable的子类控件点击时冲突"><a href="#二-解决ListView-item中含有Button或者Checkable的子类控件点击时冲突" class="headerlink" title="二.   解决ListView item中含有Button或者Checkable的子类控件点击时冲突"></a>二.   解决ListView item中含有Button或者Checkable的子类控件点击时冲突</h2><p>由于在你自己定义的Item中存在诸如Button或者Checkable的子类控件，此时这些子控件会将焦点获取到，所以常常当点击item时变化的是子控件，item本身的点击没有响应。这时候就可以使用descendantFocusability来解决啦，API描述如下：</p>
<blockquote>
<p>android:descendantFocusability<br>Defines the relationship between the ViewGroup and its descendants when looking for a View to take focus.<br>Must be one of the following constant values.</p>
</blockquote>
<p>该属性是当一个为view获取焦点时，定义viewGroup和其子控件两者之间的关系。<br>属性的值有三种：  </p>
<ul>
<li><strong>beforeDescendants</strong>：viewgroup会优先其子类控件而获取到焦点</li>
<li><strong>afterDescendants</strong>：viewgroup只有当其子类控件不需要获取焦点时才获取焦点</li>
<li><strong>blocksDescendants</strong>：viewgroup会覆盖子类控件而直接获得焦点</li>
</ul>
<p>所以解决办法： </p>
<ol>
<li>在Item布局的根布局加上<strong>android:descendantFocusability=”blocksDescendants”</strong>的属性。</li>
<li>在当前ListView的xml里添加<strong>android:descendantFocusability=”blocksDescendants”</strong> 在item的xml里的Button添加<strong>android:focusable=”false”</strong>的属性。</li>
</ol>
<h2 id="三-listview的item点击事件会使里面的Button也出现按压的效果"><a href="#三-listview的item点击事件会使里面的Button也出现按压的效果" class="headerlink" title="三.  listview的item点击事件会使里面的Button也出现按压的效果"></a>三.  listview的item点击事件会使里面的Button也出现按压的效果</h2><p>两个方案：  </p>
<ol>
<li>放弃listview的onItemClickedListener()。listview.setOnItemClickedListener(null);</li>
<li>使用自定义的Button，判断他的父控件是否press，如果是就把这个事件消耗掉，不向下传递即可；  </li>
</ol>
<blockquote>
</blockquote>
<pre><code>import android.content.Context;  
import android.util.AttributeSet;  
import android.view.View;  
import android.widget.Button;  

public class CustomButton extends Button {  
    public CustomButton(Context context) {  
        super(context);  
    }  

    public CustomButton(Context context, AttributeSet attrs) {  
        super(context, attrs);  
    }  

    public CustomButton(Context context, AttributeSet attrs, int defStyle) {  
        super(context, attrs, defStyle);  
    }  

    @Override  
    public void setPressed(boolean pressed) {  
        if (pressed &amp;&amp; getParent() instanceof View &amp;&amp; ((View) getParent()).isPressed()) {  
            return;  
        }  
        super.setPressed(pressed);  
    }  

}  
</code></pre><blockquote>
<p>参考来源：<br><a href="">“一勤天下无难事” 博客</a><br><a href="">CSDN博客</a></p>
</blockquote>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://ocnyang.com/2016/08/19/TranslucentBars/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="OCN.Yang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/ocnyang.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="杨欧神/OCN.Yang">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/08/19/TranslucentBars/" itemprop="url">
                  沉浸式状态栏攻略
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-08-19T17:03:15+08:00">
                2016-08-19
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android教程系列/" itemprop="url" rel="index">
                    <span itemprop="name">Android教程系列</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/08/19/TranslucentBars/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/08/19/TranslucentBars/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2016/08/19/TranslucentBars/" class="leancloud_visitors" data-flag-title="沉浸式状态栏攻略">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="沉浸式状态栏攻略"><a href="#沉浸式状态栏攻略" class="headerlink" title="沉浸式状态栏攻略"></a>沉浸式状态栏攻略</h1><h2 id="一、概述"><a href="#一、概述" class="headerlink" title="一、概述"></a>一、概述</h2><p>近期注意到QQ新版使用了沉浸式状态栏，ok，先声明一下：本篇博客效果下图：</p>
<p><img src="http://obbu6r1mi.bkt.clouddn.com/Immersivemenubar/1.jpg" alt="">  </p>
<p>关于这个状态栏变色到底叫「Immersive Mode」/「Translucent Bars」有兴趣可以去 <a href="http://www.zhihu.com/question/27040217" target="_blank" rel="external">为什么在国内会有很多用户把 ｢透明栏｣（Translucent Bars）称作 ｢沉浸式顶栏｣？</a>上面了解了解.</p>
<p>恩，接下来正题。  </p>
<p>首先只有大于等于4.4版本支持这个半透明状态栏的效果，但是4.4和5.0的显示效果有一定的差异，所有本篇博文内容为：</p>
<ul>
<li>如何实现半透明状态栏效果在大于4.4版本之上。</li>
<li>如何让4.4的效果与5.0的效果尽可能一致。  </li>
</ul>
<p>看了不少参考文章，都介绍到这个库，大家可以了解：<a href="https://github.com/jgilfelt/SystemBarTint" target="_blank" rel="external">SystemBarTint</a>。</p>
<p>不过本篇博文并未基于此库，自己想了个hack，对于此库源码有空再看了。</p>
<h2 id="二、效果图"><a href="#二、效果图" class="headerlink" title="二、效果图"></a>二、效果图</h2><p>先贴下效果图，以便和实现过程中做下对比</p>
<ul>
<li>4.4 模拟器</li>
</ul>
<p><img src="http://obbu6r1mi.bkt.clouddn.com/Immersivemenubar/2.gif" alt="">  </p>
<ul>
<li>5.x 真机  </li>
</ul>
<p><img src="http://obbu6r1mi.bkt.clouddn.com/Immersivemenubar/3.gif" alt="">  </p>
<p>贴个如果顶部是图片的效果图，其实是一样的，为了方便我就放侧栏的顶部了。</p>
<p><img src="http://obbu6r1mi.bkt.clouddn.com/Immersivemenubar/4.gif" alt=""></p>
<p>ok，有了效果图之后就开始看实现了。</p>
<h2 id="三、实现半透明状态栏"><a href="#三、实现半透明状态栏" class="headerlink" title="三、实现半透明状态栏"></a>三、实现半透明状态栏</h2><p>因为本例使用了NavigationView，所以布局代码稍多，当然如果你不需要，可以自己进行筛减。</p>
<p>注意引入相关依赖：</p>
<pre><code>Java

 compile &apos;com.android.support:appcompat-v7:22.2.1&apos;
 compile &apos;com.android.support:support-v4:22.2.1&apos;
 compile &apos;com.android.support:design:22.2.0&apos;
</code></pre><h3 id="（一）colors-xml-和-styles-xml"><a href="#（一）colors-xml-和-styles-xml" class="headerlink" title="（一）colors.xml 和 styles.xml"></a>（一）colors.xml 和 styles.xml</h3><p>首先我们定义几个颜色：</p>
<p>res/values/color.xml</p>
<pre><code>XHTML

&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
&lt;resources&gt;
    &lt;color name=&quot;primary&quot;&gt;#FF03A9F4&lt;/color&gt;
    &lt;color name=&quot;primary_dark&quot;&gt;#FF0288D1&lt;/color&gt;
    &lt;color name=&quot;status_bar_color&quot;&gt;@color/primary_dark&lt;/color&gt;
&lt;/resources&gt;
</code></pre><p>下面定义几个styles.xml</p>
<p>注意文件夹的路径：</p>
<p>values/styles.xml</p>
<pre><code>XHTML

&lt;resources&gt;
    &lt;style name=&quot;BaseAppTheme&quot; parent=&quot;Theme.AppCompat.Light.NoActionBar&quot;&gt;
        &lt;!-- Customize your theme here. --&gt;
        &lt;item name=&quot;colorPrimary&quot;&gt;@color/primary&lt;/item&gt;
        &lt;item name=&quot;colorPrimaryDark&quot;&gt;@color/primary_dark&lt;/item&gt;
        &lt;item name=&quot;colorAccent&quot;&gt;#FF4081&lt;/item&gt;
    &lt;/style&gt;

    &lt;!-- Base application theme. --&gt;
    &lt;style name=&quot;AppTheme&quot; parent=&quot;@style/BaseAppTheme&quot;&gt;
    &lt;/style&gt;
&lt;/resources&gt;
</code></pre><p>values-v19</p>
<pre><code>XHTML

&lt;resources&gt;
    &lt;style name=&quot;AppTheme&quot; parent=&quot;@style/BaseAppTheme&quot;&gt;
        &lt;item name=&quot;android:windowTranslucentStatus&quot;&gt;true&lt;/item&gt;
    &lt;/style&gt;
&lt;/resources&gt;
</code></pre><p>ok，这个没撒说的。注意我们的主题是基于NoActionBar的，android:windowTranslucentStatus这个属性是v19开始引入的。</p>
<h3 id="（二）布局文件"><a href="#（二）布局文件" class="headerlink" title="（二）布局文件"></a>（二）布局文件</h3><p>activity_main.xml</p>
<pre><code>XHTML

&lt;android.support.v4.widget.DrawerLayout
    xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;
    xmlns:app=&quot;http://schemas.android.com/apk/res-auto&quot;
    xmlns:tools=&quot;http://schemas.android.com/tools&quot;
    android:layout_width=&quot;match_parent&quot;
    android:layout_height=&quot;match_parent&quot;
    &gt;

    &lt;LinearLayout
        android:id=&quot;@+id/id_main_content&quot;
        android:layout_width=&quot;match_parent&quot;
        android:layout_height=&quot;match_parent&quot;
        android:orientation=&quot;vertical&quot;&gt;

        &lt;android.support.v7.widget.Toolbar
            android:id=&quot;@+id/id_toolbar&quot;
            android:layout_width=&quot;match_parent&quot;
            android:layout_height=&quot;wrap_content&quot;
            android:background=&quot;?attr/colorPrimary&quot;
            android:fitsSystemWindows=&quot;true&quot;
            app:popupTheme=&quot;@style/ThemeOverlay.AppCompat.Light&quot;/&gt;

        &lt;TextView
            android:id=&quot;@+id/id_tv_content&quot;
            android:layout_width=&quot;match_parent&quot;
            android:layout_height=&quot;0dp&quot;
            android:layout_weight=&quot;1&quot;
            android:gravity=&quot;center&quot;
            android:text=&quot;HelloWorld&quot;
            android:textSize=&quot;30sp&quot;/&gt;
    &lt;/LinearLayout&gt;

    &lt;android.support.design.widget.NavigationView
        android:id=&quot;@+id/id_nv_menu&quot;
        android:layout_width=&quot;match_parent&quot;
        android:layout_height=&quot;match_parent&quot;
        android:layout_gravity=&quot;start&quot;
        android:fitsSystemWindows=&quot;true&quot;
        app:headerLayout=&quot;@layout/header_just_username&quot;
        app:menu=&quot;@menu/menu_drawer&quot;
        /&gt;
&lt;/android.support.v4.widget.DrawerLayout&gt;
</code></pre><p>DrawerLayout内部一个LinearLayout作为内容区域，一个NavigationView作为菜单。<br>注意下Toolbar的高度设置为wrap_content。</p>
<p>然后我们的NavigationView中又依赖一个布局文件和一个menu的文件。</p>
<p>header_just_username.xml</p>
<pre><code>XHTML

&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
&lt;RelativeLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;
                android:layout_width=&quot;match_parent&quot;
                android:layout_height=&quot;192dp&quot;
                android:background=&quot;?attr/colorPrimaryDark&quot;
                android:orientation=&quot;vertical&quot;
                android:padding=&quot;16dp&quot;
                android:fitsSystemWindows=&quot;true&quot;
                android:theme=&quot;@style/ThemeOverlay.AppCompat.Dark&quot;&gt;

    &lt;TextView
        android:id=&quot;@+id/id_link&quot;
        android:layout_width=&quot;wrap_content&quot;
        android:layout_height=&quot;wrap_content&quot;
        android:layout_alignParentBottom=&quot;true&quot;
        android:layout_marginBottom=&quot;16dp&quot;
        android:text=&quot;http://blog.csdn.net/lmj623565791&quot;/&gt;

    &lt;TextView
        android:id=&quot;@+id/id_username&quot;
        android:layout_width=&quot;wrap_content&quot;
        android:layout_height=&quot;wrap_content&quot;
        android:layout_above=&quot;@id/id_link&quot;
        android:text=&quot;Zhang Hongyang&quot;/&gt;

    &lt;ImageView
        android:layout_width=&quot;72dp&quot;
        android:layout_height=&quot;72dp&quot;
        android:layout_above=&quot;@id/id_username&quot;
        android:layout_marginBottom=&quot;16dp&quot;
        android:src=&quot;@mipmap/ic_launcher&quot;/&gt;

&lt;/RelativeLayout&gt;
</code></pre><p>menu的文件就不贴了，更加详细的可以去参考Android 自己实现 NavigationView [Design Support Library(1)]。</p>
<p>大体看完布局文件以后，有几个点要特别注意：</p>
<ul>
<li>ToolBar高度设置为wrap_content</li>
<li>ToolBar添加属性android:fitsSystemWindows=”true”</li>
<li>header_just_username.xml的跟布局RelativeLayout，添加属性android:fitsSystemWindows=”true”  </li>
</ul>
<p>android:fitsSystemWindows这个属性，主要是通过调整当前设置这个属性的view的padding去为我们的status_bar留下空间。</p>
<p>根据上面的解释，如果你不写，那么状态栏和Toolbar就会有挤一块的感觉了，类似会这样：</p>
<p><img src="http://obbu6r1mi.bkt.clouddn.com/Immersivemenubar/5.jpg" alt="">  </p>
<p>ok，最后看下代码。</p>
<h3 id="（三）Activity的代码"><a href="#（三）Activity的代码" class="headerlink" title="（三）Activity的代码"></a>（三）Activity的代码</h3><pre><code>Java

package com.zhy.colorfulstatusbar;

import android.os.Bundle;
import android.support.v7.app.AppCompatActivity;
import android.support.v7.widget.Toolbar;

public class MainActivity extends AppCompatActivity
{

    @Override
    protected void onCreate(Bundle savedInstanceState)
    {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);
        Toolbar toolbar = (Toolbar) findViewById(R.id.id_toolbar);
        setSupportActionBar(toolbar);
        //StatusBarCompat.compat(this, getResources().getColor(R.color.status_bar_color));
        //StatusBarCompat.compat(this);
    }

}
</code></pre><p>没撒说的，就是setSupportActionBar。</p>
<ul>
<li>那么现在4.4的效果图是：</li>
</ul>
<p><img src="http://obbu6r1mi.bkt.clouddn.com/Immersivemenubar/6.jpg" alt="">  </p>
<p>其实还不错，有个渐变的效果。</p>
<ul>
<li>现在5.x的效果：</li>
</ul>
<p><img src="http://obbu6r1mi.bkt.clouddn.com/Immersivemenubar/7.jpg" alt=""></p>
<p>可以看到5.x默认并非是一个渐变的效果，类似是一个深一点的颜色。</p>
<p>在看看我们md的规范</p>
<p><img src="http://obbu6r1mi.bkt.clouddn.com/Immersivemenubar/8.png" alt=""></p>
<p>状态栏应该是一个比Toolbar背景色，稍微深一点的颜色。</p>
<p>这么看来，我们还是有必要去为4.4做点适配工作，让其竟可能和5.x显示效果一致，或者说尽可能符合md的规范。</p>
<h2 id="四、调整4-4的显示方案"><a href="#四、调整4-4的显示方案" class="headerlink" title="四、调整4.4的显示方案"></a>四、调整4.4的显示方案</h2><p>那么问题来了？如何做呢？</p>
<p>咱们这么看，4.4之后加入windowTranslucentStatus的属性之后，也就是我们可以用到状态栏的区域了。</p>
<p>既然我们可以用到这块区域，那么我们只要在根布局去设置一个与状态栏等高的View，设置背景色为我们期望的颜色就可以了。</p>
<p>于是有了以下的代码：</p>
<pre><code>Java

package com.zhy.colorfulstatusbar;

import android.annotation.TargetApi;
import android.app.Activity;
import android.content.Context;
import android.graphics.Color;
import android.os.Build;
import android.view.View;
import android.view.ViewGroup;

/**
 * Created by zhy on 15/9/21.
 */
public class StatusBarCompat
{
    private static final int INVALID_VAL = -1;
    private static final int COLOR_DEFAULT = Color.parseColor(&quot;#20000000&quot;);

    @TargetApi(Build.VERSION_CODES.LOLLIPOP)
    public static void compat(Activity activity, int statusColor)
    {

        if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.LOLLIPOP)
        {
            if (statusColor != INVALID_VAL)
            {
                activity.getWindow().setStatusBarColor(statusColor);
            }
            return;
        }

        if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.KITKAT &amp;&amp; Build.VERSION.SDK_INT &lt; Build.VERSION_CODES.LOLLIPOP)
        {
            int color = COLOR_DEFAULT;
            ViewGroup contentView = (ViewGroup) activity.findViewById(android.R.id.content);
            if (statusColor != INVALID_VAL)
            {
                color = statusColor;
            }
            View statusBarView = new View(activity);
            ViewGroup.LayoutParams lp = new ViewGroup.LayoutParams(ViewGroup.LayoutParams.MATCH_PARENT,
                    getStatusBarHeight(activity));
            statusBarView.setBackgroundColor(color);
            contentView.addView(statusBarView, lp);
        }

    }

    public static void compat(Activity activity)
    {
        compat(activity, INVALID_VAL);
    }

    public static int getStatusBarHeight(Context context)
    {
        int result = 0;
        int resourceId = context.getResources().getIdentifier(&quot;status_bar_height&quot;, &quot;dimen&quot;, &quot;android&quot;);
        if (resourceId &gt; 0)
        {
            result = context.getResources().getDimensionPixelSize(resourceId);
        }
        return result;
    }
}
</code></pre><p>代码的思路很简单，根据Activity找到android.R.content，在其中添加一个View(高度为statusbarHeight，背景色为我们设置的颜色，默认为半透明的黑色)。</p>
<p>那么只需要在Activity里面去写上：</p>
<pre><code>Java

StatusBarCompat.compat(this);
</code></pre><p>就可以了。</p>
<p>如果你希望自己设置状态看颜色，那么就用这个方法：</p>
<pre><code>Java

StatusBarCompat.compat(this, getResources().getColor(R.color.status_bar_color));
</code></pre><p>这样的话我们就解决了4.4到5.x的适配问题，一行代码解决，感觉还是不错的。</p>
<p>最后提一下，对于5.0由于提供了setStatusBarColor去设置状态栏颜色，但是这个方法不能在主题中设置windowTranslucentStatus属性。所以，可以编写一个value-v21文件夹，里面styles.xml写入：</p>
<pre><code>XHTML

&lt;resources&gt;
    &lt;!-- Base application theme. --&gt;
    &lt;style name=&quot;AppTheme&quot; parent=&quot;@style/BaseAppTheme&quot;&gt;
    &lt;/style&gt;
&lt;/resources&gt;
</code></pre><p>其实就是不要有windowTranslucentStatus属性。</p>
<p>接下来，对于默认的效果就不测试了，参考上面的效果图。</p>
<p>我们测试个设置状态栏颜色的，我们这里设置个红色。</p>
<ul>
<li>4.4 模拟器  </li>
</ul>
<p><img src="http://obbu6r1mi.bkt.clouddn.com/Immersivemenubar/9.gif" alt=""></p>
<ul>
<li>5.x 真机  </li>
</ul>
<p><img src="http://obbu6r1mi.bkt.clouddn.com/Immersivemenubar/10.gif" alt=""></p>
<p>ok，这样就结束啦~~</p>
<p>源码地址:<a href="https://github.com/hongyangAndroid/ColorfulStatusBar" target="_blank" rel="external">https://github.com/hongyangAndroid/ColorfulStatusBar</a></p>
<p>参考</p>
<ul>
<li><a href="http://blog.raffaeu.com/archive/2015/04/11/android-and-the-transparent-status-bar.aspx" target="_blank" rel="external">http://blog.raffaeu.com/archive/2015/04/11/android-and-the-transparent-status-bar.aspx</a></li>
<li><a href="https://mindofaandroiddev.wordpress.com/2013/12/28/making-the-status-bar-and-navigation-bar-transparent-with-a-listview-on-android-4-4-kitkat/" target="_blank" rel="external">https://mindofaandroiddev.wordpress.com/2013/12/28/making-the-status-bar-and-navigation-bar-transparent-with-a-listview-on-android-4-4-kitkat/</a></li>
<li><a href="http://www.jcodecraeer.com/a/anzhuokaifa/androidkaifa/2014/1117/1992.html" target="_blank" rel="external">http://www.jcodecraeer.com/a/anzhuokaifa/androidkaifa/2014/1117/1992.html</a>  </li>
<li><a href="http://developer.android.com/intl/zh-cn/reference/android/view/View.html#attr_android:fitsSystemWindows" target="_blank" rel="external">http://developer.android.com/intl/zh-cn/reference/android/view/View.html#attr_android:fitsSystemWindows</a>  </li>
</ul>
<blockquote>
<p>原文出处： <a href="http://blog.csdn.net/lmj623565791/article/details/48649563" target="_blank" rel="external">鸿洋</a>   </p>
</blockquote>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://ocnyang.com/2016/08/18/FragmentCreateWay/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="OCN.Yang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/ocnyang.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="杨欧神/OCN.Yang">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/08/18/FragmentCreateWay/" itemprop="url">
                  Fragment的标准写法
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-08-18T18:03:15+08:00">
                2016-08-18
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android教程系列/" itemprop="url" rel="index">
                    <span itemprop="name">Android教程系列</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/08/18/FragmentCreateWay/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/08/18/FragmentCreateWay/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2016/08/18/FragmentCreateWay/" class="leancloud_visitors" data-flag-title="Fragment的标准写法">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Fragment的标准写法"><a href="#Fragment的标准写法" class="headerlink" title="Fragment的标准写法"></a>Fragment的标准写法</h1><p>关于Fragment大家的态度可谓众说纷纭，有人说好，有人说坑。这里就不讨论了，只是着重介绍一下Fragment的一种标准的写法，从使用工厂方法来生成Fragment，到如何写回调接口，在哪里实现回调接口，在哪里注销掉回调接口。  </p>
<h3 id="标准写法"><a href="#标准写法" class="headerlink" title="标准写法"></a>标准写法</h3><pre><code>/**
 * 一个简单的Fragment子类
 * 含有这个Master_Fragment的Activity必须要去 实现 Master_Fragment.OnFragmentInteractionListener
 * 这个接口来处理Fragment与Activity的互动事件
 * 这里强烈建议使用工厂方法Master_Fragment#newInstance
 * 来创造Master_Fragment的实例.
 */
public class Master_Fragment extends Fragment {
    // 名字根据实际需求进行更改
    private static final String ARG_PARAM1 = &quot;param1&quot;;
    private static final String ARG_PARAM2 = &quot;param2&quot;;

    // 这里的参数只是一个举例可以根据需求更改
    private String mParam1;
    private String mParam2;

    private OnFragmentInteractionListener mListener;

    /**
     * 通过工厂方法来创建Fragment实例
     * 同时给Fragment来提供参数来使用
     *
     * @param param1 参数1.
     * @param param2 参数2.
     * @return Master_Fragment的实例.
     */
    public static Master_Fragment newInstance(String param1, String param2) {
        Master_Fragment fragment = new Master_Fragment();
        Bundle args = new Bundle();
        args.putString(ARG_PARAM1, param1);
        args.putString(ARG_PARAM2, param2);
        fragment.setArguments(args);
        return fragment;
    }

    /**
     * 一般情况下我们选择直接把Bundle传进来
     *
     * @param bundle
     * @return
     */
    public static Master_Fragment newInstance(Bundle bundle) {
        Master_Fragment fragment = new Master_Fragment();
        fragment.setArguments(bundle);
        return fragment;
    }

    public Master_Fragment() {
        // Required empty public constructor
    }

    @Override
    public void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        getArguData();
    }

    /**
     * 获取传进来的值
     */
    private void getArguData() {
        Bundle bundle = getArguments();
        if (bundle != null) {
            mParam1 = bundle.getString(ARG_PARAM1);
            mParam2 = bundle.getString(ARG_PARAM2);
        }
    }

    @Override
    public View onCreateView(LayoutInflater inflater, ViewGroup container,
                             Bundle savedInstanceState) {
        return inflater.inflate(R.layout.fragment_master_layout, container, false);
    }

    // TODO: Rename method, update argument and hook method into UI event
    public void onButtonPressed(Uri uri) {
        if (mListener != null) {
            mListener.onFragmentInteraction(uri);
        }
    }

    /**
     * onAttach中连接监听接口 确保Activity支持该接口
     */
    @Override
    public void onAttach(Activity activity) {
        super.onAttach(activity);
        try {
            mListener = (OnFragmentInteractionListener) activity;
        } catch (ClassCastException e) {
            throw new ClassCastException(activity.toString()
                    + &quot; must implement OnFragmentInteractionListener&quot;);
        }
    }

    /**
     * onDetach中注销接口
     */
    @Override
    public void onDetach() {
        super.onDetach();
        mListener = null;
    }

    /**
     * 这个互动接口必须被含有Master_Fragment 的Activity继承
     * 来实现Fragment与Activity直接的互通
     * 更多信息请参考
     * &quot;http://developer.android.com/training/basics/fragments/communicating.html&quot;
     * &gt;Communicating with Other Fragments&lt;/a&gt; .
     */
    public interface OnFragmentInteractionListener {
        // 根据实际需求更改
        public void onFragmentInteraction(Uri uri);
    }
}
</code></pre><h3 id="注意的点"><a href="#注意的点" class="headerlink" title="注意的点"></a>注意的点</h3><ol>
<li>推荐使用newInstance工厂方法来生成Fragment的实例</li>
<li>Activity和Fragment直接的互通使用回调接口完成</li>
<li>onAttach中监听接口，在onDetach中注销接口</li>
</ol>
<p>以上代码为Android Studio自动生成更多信息请参考： <a href="http://developer.android.com/training/basics/fragments/communicating.html" target="_blank" rel="external">http://developer.android.com/training/basics/fragments/communicating.html</a>  </p>
<blockquote>
<p>摘录来源：<a href="http://blog.csdn.net/dantestones/article/details/46848939" target="_blank" rel="external">还不走A：Android Fragment的标准写法</a></p>
</blockquote>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://ocnyang.com/2016/08/17/GlideUse/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="OCN.Yang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/ocnyang.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="杨欧神/OCN.Yang">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/08/17/GlideUse/" itemprop="url">
                  Glide图片加载库的使用
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-08-17T17:03:15+08:00">
                2016-08-17
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/第三方框架/" itemprop="url" rel="index">
                    <span itemprop="name">第三方框架</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/08/17/GlideUse/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/08/17/GlideUse/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2016/08/17/GlideUse/" class="leancloud_visitors" data-flag-title="Glide图片加载库的使用">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Glide图片加载库的使用"><a href="#Glide图片加载库的使用" class="headerlink" title="Glide图片加载库的使用"></a>Glide图片加载库的使用</h1><p>Glide是 Google推荐的图片加载库,它可以支持来自url,Android资源,文件,Uri中的图片加载,同时还支持gif图片的加载,以及各种图片显示前的bitmap处理(例如:圆角图片,圆形图片,高斯模糊,旋转,灰度等等),缓存处理,请求优先级处理,动画处理,缩略图处理,图片大小自定义等等.可谓是非常的强大.</p>
<h2 id="1-添加Glide库"><a href="#1-添加Glide库" class="headerlink" title="1.添加Glide库"></a>1.添加Glide库</h2><p>需要在build.gradle中加入依赖,目前最新的版本是3.7.0,<a href="https://github.com/bumptech/glide" target="_blank" rel="external">Glide库地址</a>  </p>
<pre><code class="java">compile <span class="string">'com.github.bumptech.glide:glide:3.7.0'</span>
</code></pre>
<h2 id="2-加载网络图片"><a href="#2-加载网络图片" class="headerlink" title="2.加载网络图片"></a>2.加载网络图片</h2><pre><code>/**
 * Created by mChenys on 2016/6/6.
 */
public class TestGlideActivity extends Activity {
    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_test);
        String url = &quot;http://www.qq745.com/uploads/allimg/141106/1-141106153Q5.png&quot;;
        ImageView targetView = (ImageView) findViewById(R.id.iv_target);
        Glide.with(this).
                load(url).
                asBitmap(). //强制处理为bitmap
                into(targetView);//显示到目标View中
    }
}
</code></pre><h2 id="3-加载资源图片"><a href="#3-加载资源图片" class="headerlink" title="3.加载资源图片"></a>3.加载资源图片</h2><pre><code>public class TestGlideActivity extends Activity {
    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_test);
        int resourceId = R.drawable.test;
        ImageView targetView = (ImageView) findViewById(R.id.iv_target);
        Glide.with(this).
                load(resourceId).
                asBitmap().
                into(targetView);
    }
}
</code></pre><h2 id="4-加载本地文件图片"><a href="#4-加载本地文件图片" class="headerlink" title="4.加载本地文件图片"></a>4.加载本地文件图片</h2><pre><code>public class TestGlideActivity extends Activity {
    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_test);
        File file = new File(Environment.getExternalStorageDirectory(), &quot;test.jpg&quot;);
        ImageView targetView = (ImageView) findViewById(R.id.iv_target);
        Glide.with(this).
                load(file).
                asBitmap().
                into(targetView);
    }
}
</code></pre><h2 id="5-从Uri中加载"><a href="#5-从Uri中加载" class="headerlink" title="5.从Uri中加载"></a>5.从Uri中加载</h2><pre><code>/**
 * Created by mChenys on 2016/6/6.
 */
public class TestGlideActivity extends Activity {
    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_test);
        Uri uri = Uri.parse(&quot;android.resource://&quot; + this.getPackageName() + &quot;/&quot; + R.drawable.test);
        ImageView targetView = (ImageView) findViewById(R.id.iv_target);
        Glide.with(this).
                load(uri).
                asBitmap().
                into(targetView);
    }
}
</code></pre><h2 id="6-加载gif图片"><a href="#6-加载gif图片" class="headerlink" title="6.加载gif图片"></a>6.加载gif图片</h2><pre><code>public class TestGlideActivity extends Activity {
    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_test);
        ImageView targetView = (ImageView) findViewById(R.id.iv_target);
        Glide.with(this).
                load(R.drawable.smail).
                asGif().//注意:这里显示的指明了要加载的是gif图片,当然即使不指明,glide也会自己判断.
                into(targetView);
    }
}
</code></pre><p>效果图:<br><img src="http://img.blog.csdn.net/20160606225115608" alt="">  </p>
<h2 id="7-设置默认图片和加载失败时显示的图片"><a href="#7-设置默认图片和加载失败时显示的图片" class="headerlink" title="7.设置默认图片和加载失败时显示的图片"></a>7.设置默认图片和加载失败时显示的图片</h2><pre><code>public class TestGlideActivity extends Activity {
    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_test);
        ImageView targetView = (ImageView) findViewById(R.id.iv_target);
        Glide.with(this).
                load(R.drawable.test).
                asBitmap().
                placeholder(R.drawable.bg_loading).//加载中显示的图片
                error(R.drawable.bg_error).//加载失败时显示的图片
                into(targetView);
    }
}
</code></pre><h2 id="8-淡入显示效果"><a href="#8-淡入显示效果" class="headerlink" title="8.淡入显示效果"></a>8.淡入显示效果</h2><pre><code>public class TestGlideActivity extends Activity {
    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_test);
        ImageView targetView = (ImageView) findViewById(R.id.iv_target);
        Glide.with(this).
                load(R.drawable.test).
                placeholder(R.drawable.bg_loading).//加载中显示的图片
                error(R.drawable.bg_error).//加载失败时显示的图片
                crossFade().//淡入显示,注意:如果设置了这个,则必须要去掉asBitmap
                into(targetView);
    }
}
</code></pre><p>另外,crossFade还可以接收一个参数来设置淡入显示效果的持续时间,crossFade(int duration);<br>如果你想直接显示图片,而不是淡入显示图片,则可以通过dontAnimate()方法设置.</p>
<h2 id="9-调整图片像素大小"><a href="#9-调整图片像素大小" class="headerlink" title="9.调整图片像素大小"></a>9.调整图片像素大小</h2><pre><code>public class TestGlideActivity extends Activity {
    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_test);
        ImageView targetView = (ImageView) findViewById(R.id.iv_target);
        Glide.with(this).
                load(R.drawable.test).
                placeholder(R.drawable.bg_loading).//加载中显示的图片
                error(R.drawable.bg_error).//加载失败时显示的图片
                crossFade(1000).//淡入显示的时间,注意:如果设置了这个,则必须要去掉asBitmap
                override(80,80).//设置最终显示的图片像素为80*80,注意:这个是像素,而不是控件的宽高
                into(targetView);
    }
}
</code></pre><h2 id="10-设置CenterCrop-FitCenter"><a href="#10-设置CenterCrop-FitCenter" class="headerlink" title="10.设置CenterCrop,FitCenter"></a>10.设置CenterCrop,FitCenter</h2><p>CenterCrop,FitCenter都是对目标图片进行裁剪,了解过ImageView的ScaleType属性就知道,这2种裁剪方式在ImageView上也是有的,分别对应ImageView的ImageView.ScaleType.CENTER_CROP和mageView.ScaleType.FIT_CENTER的.</p>
<pre><code>public class TestGlideActivity extends Activity {
    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_test);
        ImageView targetView = (ImageView) findViewById(R.id.iv_target);
        targetView.setScaleType(ImageView.ScaleType.FIT_CENTER);
        Glide.with(this).
                load(R.drawable.test).
                placeholder(R.drawable.bg_loading).//加载中显示的图片
                error(R.drawable.bg_error).//加载失败时显示的图片
                crossFade(1000).//淡入淡出,注意:如果设置了这个,则必须要去掉asBitmap
                override(80,80).//设置最终显示的图片像素为80*80,注意:这个是像素,而不是控件的宽高
                centerCrop().//中心裁剪,缩放填充至整个ImageView
                into(targetView);
    }
}
</code></pre><h2 id="11-缓存策略设置"><a href="#11-缓存策略设置" class="headerlink" title="11.缓存策略设置"></a>11.缓存策略设置</h2><p>内存缓存设置,通过skipMemoryCache(boolean)来设置是否需要缓存到内存,默认是会缓存到内存的.</p>
<pre><code>/**
 * Created by mChenys on 2016/6/6.
 */
public class TestGlideActivity extends Activity {
    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_test);
        ImageView targetView = (ImageView) findViewById(R.id.iv_target);
        targetView.setScaleType(ImageView.ScaleType.FIT_CENTER);
        Glide.with(this).
                load(R.drawable.test).
                placeholder(R.drawable.bg_loading).//加载中显示的图片
                error(R.drawable.bg_error).//加载失败时显示的图片
                crossFade(1000).//淡入淡出,注意:如果设置了这个,则必须要去掉asBitmap
                override(80,80).//设置最终显示的图片像素为80*80,注意:这个是像素,而不是控件的宽高
                centerCrop().//中心裁剪,缩放填充至整个ImageView
                skipMemoryCache(true).//跳过内存缓存
                into(targetView);
    }
}
</code></pre><p>磁盘缓存,磁盘缓存通过diskCacheStrategy(DiskCacheStrategy)来设置,DiskCacheStrategy一共有4种模式:  </p>
<ul>
<li>DiskCacheStrategy.NONE:什么都不缓存</li>
<li>DiskCacheStrategy.SOURCE:仅缓存原图(全分辨率的图片)</li>
<li>DiskCacheStrategy.RESULT:仅缓存最终的图片,即修改了尺寸或者转换后的图片</li>
<li>DiskCacheStrategy.ALL:缓存所有版本的图片,默认模式<br>&gt;</li>
</ul>
<pre><code>public class TestGlideActivity extends Activity {
    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_test);
        ImageView targetView = (ImageView) findViewById(R.id.iv_target);
        targetView.setScaleType(ImageView.ScaleType.FIT_CENTER);
        Glide.with(this).
                load(R.drawable.test).
                placeholder(R.drawable.bg_loading).//加载中显示的图片
                error(R.drawable.bg_error).//加载失败时显示的图片
                crossFade(1000).//淡入淡出,注意:如果设置了这个,则必须要去掉asBitmap
                override(80, 80).//设置最终显示的图片像素为80*80,注意:这个是像素,而不是控件的宽高
                centerCrop().//中心裁剪,缩放填充至整个ImageView
                skipMemoryCache(true).//跳过内存缓存
                diskCacheStrategy(DiskCacheStrategy.RESULT).//保存最终图片
                into(targetView);
    }
}
</code></pre><h2 id="12-缓存设置"><a href="#12-缓存设置" class="headerlink" title="12.缓存设置"></a>12.缓存设置</h2><p>在GlideModule 中,我们可以设置磁盘缓存的位置,磁盘缓存的大小和内存缓存的大小,同时还可以设置图片的显示质量.  </p>
<p>要是用GlideModule ,需要创建它的实现类,然后在manifests中申明实现类的全类路径:</p>
<pre><code>&lt;meta-data
          android:name=&quot;com.example.mchenys.httputilsdemo.image.glide.module.SimpleGlideModule&quot;
          android:value=&quot;GlideModule&quot; /&gt;
</code></pre><p>GlideModule 的实现类,需要实现applyOptions方法:</p>
<pre><code>/**
 * 所以你知道要创建一个额外的类去定制 Glide。
 * 下一步是要全局的去声明这个类，让 Glide 知道它应该在哪里被加载和使用。
 * Glide 会扫描 AndroidManifest.xml 为 Glide module 的 meta 声明。
 * 因此，你必须在 AndroidManifest.xml 的 &lt;application&gt; 标签内去声明这个SimpleGlideModule。
 * Created by mChenys on 2016/6/10.
 */
public class SimpleGlideModule implements GlideModule {
    public static DiskCache cache;

    @Override
    public void applyOptions(Context context, GlideBuilder builder) {
        // 在 Android 中有两个主要的方法对图片进行解码：ARGB8888 和 RGB565。前者为每个像素使用了 4 个字节，
        // 后者仅为每个像素使用了 2 个字节。ARGB8888 的优势是图像质量更高以及能存储一个 alpha 通道。
        // Picasso 使用 ARGB8888，Glide 默认使用低质量的 RGB565。
        // 对于 Glide 使用者来说：你使用 Glide module 方法去改变解码规则。
        builder.setDecodeFormat(DecodeFormat.PREFER_ARGB_8888);
        //设置缓存目录
        File cacheDir = PathUtils.getDiskCacheDir(context, CacheConfig.IMG_DIR);

        cache = DiskLruCacheWrapper.get(cacheDir, DiskCache.Factory.DEFAULT_DISK_CACHE_SIZE);// 250 MB
        builder.setDiskCache(new DiskCache.Factory() {
            @Override
            public DiskCache build() {
                return cache;
            }
        });
        //设置memory和Bitmap池的大小
        MemorySizeCalculator calculator = new MemorySizeCalculator(context);
        int defaultMemoryCacheSize = calculator.getMemoryCacheSize();
        int defaultBitmapPoolSize = calculator.getBitmapPoolSize();

        int customMemoryCacheSize = (int) (1.2 * defaultMemoryCacheSize);
        int customBitmapPoolSize = (int) (1.2 * defaultBitmapPoolSize);

        builder.setMemoryCache(new LruResourceCache(customMemoryCacheSize));
        builder.setBitmapPool(new LruBitmapPool(customBitmapPoolSize));
    }

    @Override
    public void registerComponents(Context context, Glide glide) {
    }
}
</code></pre><h2 id="13-设置图片请求的优先级"><a href="#13-设置图片请求的优先级" class="headerlink" title="13.设置图片请求的优先级"></a>13.设置图片请求的优先级</h2><p>Glide 可以用 Priority 枚举来设置图片的加载优先级,这样我们就可以针对那些需要显示的图片设置高的优先级了.</p>
<p>Priority 有4种级别:</p>
<ul>
<li>Priority.LOW  </li>
<li>Priority.NORMAL  </li>
<li>Priority.HIGH  </li>
<li>Priority.IMMEDIATE  </li>
</ul>
<p>例如:</p>
<pre><code>/**
    * 高优先级加载
    * @param url
    * @param imageView
    * @param listener
    */
   public static void loadImageWithHighPriority(Object url,ImageView imageView, final LoaderListener listener) {
       if (url == null) {
           if (listener != null) {
               listener.onError();
           }
       } else {
           Glide.with(imageView.getContext()).
                   load(url).
                   asBitmap().
                   priority(Priority.HIGH).//高优先级
                   dontAnimate().
                   listener(new RequestListener&lt;Object, Bitmap&gt;() {
                       @Override
                       public boolean onException(Exception e, Object model, Target&lt;Bitmap&gt; target, boolean isFirstResource) {
                           if (null != listener) {
                               listener.onError();
                           }
                           return false;
                       }

                       @Override
                       public boolean onResourceReady(Bitmap resource, Object model, Target&lt;Bitmap&gt; target, boolean isFromMemoryCache, boolean isFirstResource) {
                           if (null != listener) {
                               listener.onSuccess();
                           }
                           return false;
                       }
                   }).into(imageView);
       }
   }
</code></pre><h2 id="14-设置加载缩略图"><a href="#14-设置加载缩略图" class="headerlink" title="14.设置加载缩略图"></a>14.设置加载缩略图</h2><p>通过设置缩略图,我们可以在显示目标图片之前先展示一个第分辨率或者其他图片,当全分辨率的目标图片在后台加载完成后,<br>Glide会自动切换显示全像素的目标图片.  </p>
<p>设置缩略图有2种方式:<br>通过thumbnail(float)指定0.0f~1.0f的原始图像大小,例如全像素的大小是500<em>500,如果设置为thumbnail为0.1f,即目标图片的10%,显示的缩略图大小就是50</em>50;</p>
<pre><code>public class TestGlideActivity extends Activity {
    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_test);
        ImageView targetView = (ImageView) findViewById(R.id.iv_target);

        Glide.with(this).
                load(R.drawable.test).
                placeholder(R.drawable.bg_loading).//加载中显示的图片
                error(R.drawable.bg_error).//加载失败时显示的图片
                crossFade(1000).//淡入淡出,注意:如果设置了这个,则必须要去掉asBitmap
                override(80, 80).//设置最终显示的图片像素为80*80,注意:这个是像素,而不是控件的宽高
                centerCrop().//中心裁剪,缩放填充至整个ImageView
                skipMemoryCache(true).//跳过内存缓存
                diskCacheStrategy(DiskCacheStrategy.RESULT).//保存最终图片
                thumbnail(0.1f).//10%的原图大小
                into(targetView);
    }
}
</code></pre><p>通过thumbnail(DrawableRequestBuilder)方式来指定缩略图,该缩略图可以使用load的所有方式(网络,文件,uri,资源)加载.</p>
<pre><code>public class TestGlideActivity extends Activity {
    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_test);
        ImageView targetView = (ImageView) findViewById(R.id.iv_target);
        //缩略图请求
        DrawableRequestBuilder&lt;String&gt; thumbnailRequest = Glide
                .with(this)
                .load(&quot;http://www.qq745.com/uploads/allimg/141106/1-141106153Q5.png&quot;);

        Glide.with(this).
                load(R.drawable.test).
//                placeholder(R.drawable.bg_loading).//加载中显示的图片
//                error(R.drawable.bg_error).//加载失败时显示的图片
//                crossFade(1000).//淡入淡出,注意:如果设置了这个,则必须要去掉asBitmap
                override(80, 80).//设置最终显示的图片像素为80*80,注意:这个是像素,而不是控件的宽高
                centerCrop().//中心裁剪,缩放填充至整个ImageView
                skipMemoryCache(true).//跳过内存缓存
                diskCacheStrategy(DiskCacheStrategy.RESULT).//保存最终图片
                thumbnail(thumbnailRequest).//设置缩略图
                into(targetView);
    }
}
</code></pre><h2 id="15-Transformations-Bitmap"><a href="#15-Transformations-Bitmap" class="headerlink" title="15.Transformations Bitmap"></a>15.Transformations Bitmap</h2><p>在显示目标图片之前,我们可以对目标图片的Bitmap进行相应的处理,例如::圆角图片,圆形图片,高斯模糊,旋转,灰度等等.<br>只需要实现Transformation接口即可,该接口的transform方法会返回显示图片前的Bitmap对象,在该方法中对<br>Bitmap的任何处理,都会影响到最终的显示结果.<br>当然,如果你只是想要对图片做常规的 bitmap 转换，你可以继承抽象类BitmapTransformation,它简化了Transformation接口的实现，这应该能覆盖大部分的应用场景了。  </p>
<p>使用的时候,通过transform(Transformation… transformations)来设置.例如:  </p>
<pre><code>public class TestGlideActivity extends Activity {
    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_test);
        ImageView targetView = (ImageView) findViewById(R.id.iv_target);
        Glide.with(this).
                load(R.drawable.test).
                asBitmap().
                transform(new BlurTransformation(this)).//高斯模糊处理
                into(targetView);
    }
}
</code></pre><p>下面贴出常用的几个Bitmap的转换处理的代码,在github上也有glide-transformations-master库.  </p>
<h3 id="圆图处理"><a href="#圆图处理" class="headerlink" title="圆图处理"></a>圆图处理</h3><pre><code>public class CropCircleTransformation implements Transformation&lt;Bitmap&gt; {

    private BitmapPool mBitmapPool;

    public CropCircleTransformation(Context context) {
        this(Glide.get(context).getBitmapPool());
    }

    public CropCircleTransformation(BitmapPool pool) {
        this.mBitmapPool = pool;
    }

    @Override
    public Resource&lt;Bitmap&gt; transform(Resource&lt;Bitmap&gt; resource, int outWidth, int outHeight) {
        Bitmap source = resource.get();
        int size = Math.min(source.getWidth(), source.getHeight());

        int width = (source.getWidth() - size) / 2;
        int height = (source.getHeight() - size) / 2;

        Bitmap bitmap = mBitmapPool.get(size, size, Bitmap.Config.ARGB_8888);
        if (bitmap == null) {
            bitmap = Bitmap.createBitmap(size, size, Bitmap.Config.ARGB_8888);
        }

        Canvas canvas = new Canvas(bitmap);
        Paint paint = new Paint();
        BitmapShader shader =
                new BitmapShader(source, BitmapShader.TileMode.CLAMP, BitmapShader.TileMode.CLAMP);
        if (width != 0 || height != 0) {
            // source isn&apos;t square, move viewport to center
            Matrix matrix = new Matrix();
            matrix.setTranslate(-width, -height);
            shader.setLocalMatrix(matrix);
        }
        paint.setShader(shader);
        paint.setAntiAlias(true);

        float r = size / 2f;
        canvas.drawCircle(r, r, r, paint);

        return BitmapResource.obtain(bitmap, mBitmapPool);
    }

    @Override public String getId() {
        return &quot;CropCircleTransformation()&quot;;
    }
}
</code></pre><h3 id="圆角处理"><a href="#圆角处理" class="headerlink" title="圆角处理"></a>圆角处理</h3><pre><code>public class RoundedCornersTransformation implements Transformation&lt;Bitmap&gt; {

    private BitmapPool mBitmapPool;

    private int radius;
    private int margin;

    public RoundedCornersTransformation(Context context, int radius, int margin) {
        this(Glide.get(context).getBitmapPool(), radius, margin);
    }

    public RoundedCornersTransformation(BitmapPool pool, int radius, int margin) {
        mBitmapPool = pool;
        this.radius = radius;
        this.margin = margin;
    }

    @Override
    public Resource&lt;Bitmap&gt; transform(Resource&lt;Bitmap&gt; resource, int outWidth, int outHeight) {
        Bitmap source = resource.get();

        int width = source.getWidth();
        int height = source.getHeight();

        Bitmap bitmap = mBitmapPool.get(width, height, Bitmap.Config.ARGB_8888);
        if (bitmap == null) {
            bitmap = Bitmap.createBitmap(width, height, Bitmap.Config.ARGB_8888);
        }

        Canvas canvas = new Canvas(bitmap);
        Paint paint = new Paint();
        paint.setAntiAlias(true);
        paint.setShader(new BitmapShader(source, Shader.TileMode.CLAMP, Shader.TileMode.CLAMP));
        canvas.drawRoundRect(new RectF(margin, margin, width - margin, height - margin), radius, radius,
                paint);

        return BitmapResource.obtain(bitmap, mBitmapPool);
    }

    @Override public String getId() {
        return &quot;RoundedTransformation(radius=&quot; + radius + &quot;, margin=&quot; + margin + &quot;)&quot;;
    }
}
</code></pre><h3 id="灰度处理"><a href="#灰度处理" class="headerlink" title="灰度处理"></a>灰度处理</h3><pre><code>public class GrayscaleTransformation implements Transformation&lt;Bitmap&gt; {

    private BitmapPool mBitmapPool;

    public GrayscaleTransformation(Context context) {
        this(Glide.get(context).getBitmapPool());
    }

    public GrayscaleTransformation(BitmapPool pool) {
        mBitmapPool = pool;
    }

    @Override
    public Resource&lt;Bitmap&gt; transform(Resource&lt;Bitmap&gt; resource, int outWidth, int outHeight) {
        Bitmap source = resource.get();

        int width = source.getWidth();
        int height = source.getHeight();

        Bitmap.Config config =
                source.getConfig() != null ? source.getConfig() : Bitmap.Config.ARGB_8888;
        Bitmap bitmap = mBitmapPool.get(width, height, config);
        if (bitmap == null) {
            bitmap = Bitmap.createBitmap(width, height, config);
        }

        Canvas canvas = new Canvas(bitmap);
        ColorMatrix saturation = new ColorMatrix();
        saturation.setSaturation(0f);
        Paint paint = new Paint();
        paint.setColorFilter(new ColorMatrixColorFilter(saturation));
        canvas.drawBitmap(source, 0, 0, paint);

        return BitmapResource.obtain(bitmap, mBitmapPool);
    }

    @Override public String getId() {
        return &quot;GrayscaleTransformation()&quot;;
    }
}
</code></pre><h3 id="旋转处理"><a href="#旋转处理" class="headerlink" title="旋转处理"></a>旋转处理</h3><pre><code>public class RotateTransformation extends BitmapTransformation {

    private float rotateRotationAngle = 0f;

    public RotateTransformation(Context context, float rotateRotationAngle) {
        super(context);

        this.rotateRotationAngle = rotateRotationAngle;
    }

    @Override
    protected Bitmap transform(BitmapPool pool, Bitmap toTransform, int outWidth, int outHeight) {
        Matrix matrix = new Matrix();

        matrix.postRotate(rotateRotationAngle);

        return Bitmap.createBitmap(toTransform, 0, 0, toTransform.getWidth(), toTransform.getHeight(), matrix, true);
    }

    @Override
    public String getId() {
        return &quot;rotate&quot; + rotateRotationAngle;
    }
}
</code></pre><h3 id="高斯模糊处理"><a href="#高斯模糊处理" class="headerlink" title="高斯模糊处理"></a>高斯模糊处理</h3><pre><code>public class BlurTransformation implements Transformation&lt;Bitmap&gt; {

    private static int MAX_RADIUS = 25;
    private static int DEFAULT_DOWN_SAMPLING = 1;

    private Context mContext;
    private BitmapPool mBitmapPool;

    private int mRadius;
    private int mSampling;

    public BlurTransformation(Context context) {
        this(context, Glide.get(context).getBitmapPool(), MAX_RADIUS, DEFAULT_DOWN_SAMPLING);
    }

    public BlurTransformation(Context context, BitmapPool pool) {
        this(context, pool, MAX_RADIUS, DEFAULT_DOWN_SAMPLING);
    }

    public BlurTransformation(Context context, BitmapPool pool, int radius) {
        this(context, pool, radius, DEFAULT_DOWN_SAMPLING);
    }

    public BlurTransformation(Context context, int radius) {
        this(context, Glide.get(context).getBitmapPool(), radius, DEFAULT_DOWN_SAMPLING);
    }

    public BlurTransformation(Context context, BitmapPool pool, int radius, int sampling) {
        mContext = context;
        mBitmapPool = pool;
        mRadius = radius;
        mSampling = sampling;
    }

    public BlurTransformation(Context context, int radius, int sampling) {
        mContext = context;
        mBitmapPool = Glide.get(context).getBitmapPool();
        mRadius = radius;
        mSampling = sampling;
    }

    @Override
    public Resource&lt;Bitmap&gt; transform(Resource&lt;Bitmap&gt; resource, int outWidth, int outHeight) {
        Bitmap source = resource.get();

        int width = source.getWidth();
        int height = source.getHeight();
        int scaledWidth = width / mSampling;
        int scaledHeight = height / mSampling;

        Bitmap bitmap = mBitmapPool.get(scaledWidth, scaledHeight, Bitmap.Config.ARGB_8888);
        if (bitmap == null) {
            bitmap = Bitmap.createBitmap(scaledWidth, scaledHeight, Bitmap.Config.ARGB_8888);
        }

        Canvas canvas = new Canvas(bitmap);
        canvas.scale(1 / (float) mSampling, 1 / (float) mSampling);
        Paint paint = new Paint();
        paint.setFlags(Paint.FILTER_BITMAP_FLAG);
        canvas.drawBitmap(source, 0, 0, paint);

        if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.JELLY_BEAN_MR2) {
            try {
                bitmap = RSBlur.blur(mContext, bitmap, mRadius);
            } catch (RSRuntimeException e) {
                bitmap = FastBlur.blur(bitmap, mRadius, true);
            }
        } else {
            bitmap = FastBlur.blur(bitmap, mRadius, true);
        }

        return BitmapResource.obtain(bitmap, mBitmapPool);
    }

    @Override public String getId() {
        return &quot;BlurTransformation(radius=&quot; + mRadius + &quot;, sampling=&quot; + mSampling + &quot;)&quot;;
    }
}
</code></pre><p>网上提供的FastBlur,<strong>可兼容低版本的高斯模糊处理</strong></p>
<pre><code>public class FastBlur {

    public static Bitmap blur(Bitmap sentBitmap, int radius, boolean canReuseInBitmap) {

        Bitmap bitmap;
        if (canReuseInBitmap) {
            bitmap = sentBitmap;
        } else {
            bitmap = sentBitmap.copy(sentBitmap.getConfig(), true);
        }

        if (radius &lt; 1) {
            return (null);
        }

        int w = bitmap.getWidth();
        int h = bitmap.getHeight();

        int[] pix = new int[w * h];
        bitmap.getPixels(pix, 0, w, 0, 0, w, h);

        int wm = w - 1;
        int hm = h - 1;
        int wh = w * h;
        int div = radius + radius + 1;

        int r[] = new int[wh];
        int g[] = new int[wh];
        int b[] = new int[wh];
        int rsum, gsum, bsum, x, y, i, p, yp, yi, yw;
        int vmin[] = new int[Math.max(w, h)];

        int divsum = (div + 1) &gt;&gt; 1;
        divsum *= divsum;
        int dv[] = new int[256 * divsum];
        for (i = 0; i &lt; 256 * divsum; i++) {
            dv[i] = (i / divsum);
        }

        yw = yi = 0;

        int[][] stack = new int[div][3];
        int stackpointer;
        int stackstart;
        int[] sir;
        int rbs;
        int r1 = radius + 1;
        int routsum, goutsum, boutsum;
        int rinsum, ginsum, binsum;

        for (y = 0; y &lt; h; y++) {
            rinsum = ginsum = binsum = routsum = goutsum = boutsum = rsum = gsum = bsum = 0;
            for (i = -radius; i &lt;= radius; i++) {
                p = pix[yi + Math.min(wm, Math.max(i, 0))];
                sir = stack[i + radius];
                sir[0] = (p &amp;amp; 0xff0000) &gt;&gt; 16;
                sir[1] = (p &amp;amp; 0x00ff00) &gt;&gt; 8;
                sir[2] = (p &amp;amp; 0x0000ff);
                rbs = r1 - Math.abs(i);
                rsum += sir[0] * rbs;
                gsum += sir[1] * rbs;
                bsum += sir[2] * rbs;
                if (i &gt; 0) {
                    rinsum += sir[0];
                    ginsum += sir[1];
                    binsum += sir[2];
                } else {
                    routsum += sir[0];
                    goutsum += sir[1];
                    boutsum += sir[2];
                }
            }
            stackpointer = radius;

            for (x = 0; x &lt; w; x++) {

                r[yi] = dv[rsum];
                g[yi] = dv[gsum];
                b[yi] = dv[bsum];

                rsum -= routsum;
                gsum -= goutsum;
                bsum -= boutsum;

                stackstart = stackpointer - radius + div;
                sir = stack[stackstart % div];

                routsum -= sir[0];
                goutsum -= sir[1];
                boutsum -= sir[2];

                if (y == 0) {
                    vmin[x] = Math.min(x + radius + 1, wm);
                }
                p = pix[yw + vmin[x]];

                sir[0] = (p &amp;amp; 0xff0000) &gt;&gt; 16;
                sir[1] = (p &amp;amp; 0x00ff00) &gt;&gt; 8;
                sir[2] = (p &amp;amp; 0x0000ff);

                rinsum += sir[0];
                ginsum += sir[1];
                binsum += sir[2];

                rsum += rinsum;
                gsum += ginsum;
                bsum += binsum;

                stackpointer = (stackpointer + 1) % div;
                sir = stack[(stackpointer) % div];

                routsum += sir[0];
                goutsum += sir[1];
                boutsum += sir[2];

                rinsum -= sir[0];
                ginsum -= sir[1];
                binsum -= sir[2];

                yi++;
            }
            yw += w;
        }
        for (x = 0; x &lt; w; x++) {
            rinsum = ginsum = binsum = routsum = goutsum = boutsum = rsum = gsum = bsum = 0;
            yp = -radius * w;
            for (i = -radius; i &lt;= radius; i++) {
                yi = Math.max(0, yp) + x;

                sir = stack[i + radius];

                sir[0] = r[yi];
                sir[1] = g[yi];
                sir[2] = b[yi];

                rbs = r1 - Math.abs(i);

                rsum += r[yi] * rbs;
                gsum += g[yi] * rbs;
                bsum += b[yi] * rbs;

                if (i &gt; 0) {
                    rinsum += sir[0];
                    ginsum += sir[1];
                    binsum += sir[2];
                } else {
                    routsum += sir[0];
                    goutsum += sir[1];
                    boutsum += sir[2];
                }

                if (i &lt; hm) {
                    yp += w;
                }
            }
            yi = x;
            stackpointer = radius;
            for (y = 0; y &lt; h; y++) {
                // Preserve alpha channel: ( 0xff000000 &amp;amp; pix[yi] )
                pix[yi] = (0xff000000 &amp;amp; pix[yi]) | (dv[rsum] &lt; 16) | (dv[gsum] &lt; 8) | dv[bsum];

                rsum -= routsum;
                gsum -= goutsum;
                bsum -= boutsum;

                stackstart = stackpointer - radius + div;
                sir = stack[stackstart % div];

                routsum -= sir[0];
                goutsum -= sir[1];
                boutsum -= sir[2];

                if (x == 0) {
                    vmin[y] = Math.min(y + r1, hm) * w;
                }
                p = x + vmin[y];

                sir[0] = r[p];
                sir[1] = g[p];
                sir[2] = b[p];

                rinsum += sir[0];
                ginsum += sir[1];
                binsum += sir[2];

                rsum += rinsum;
                gsum += ginsum;
                bsum += binsum;

                stackpointer = (stackpointer + 1) % div;
                sir = stack[stackpointer];

                routsum += sir[0];
                goutsum += sir[1];
                boutsum += sir[2];

                rinsum -= sir[0];
                ginsum -= sir[1];
                binsum -= sir[2];

                yi += w;
            }
        }

        bitmap.setPixels(pix, 0, w, 0, 0, w, h);

        return (bitmap);
    }
}
</code></pre><h3 id="RenderScript处理高斯模糊"><a href="#RenderScript处理高斯模糊" class="headerlink" title="RenderScript处理高斯模糊"></a>RenderScript处理高斯模糊</h3><blockquote>
<p>android4.3之后可使用,需要在build.gradle中配置:</p>
</blockquote>
<pre><code>defaultConfig {
    //BlurTransformation
    renderscriptTargetApi 23
    renderscriptSupportModeEnabled true
}
</code></pre><p>&gt;</p>
<pre><code>public class RSBlur {

    @TargetApi(Build.VERSION_CODES.JELLY_BEAN_MR2)
    public static Bitmap blur(Context context, Bitmap blurredBitmap, int radius) throws RSRuntimeException {
        try {
            RenderScript rs = RenderScript.create(context);
            Allocation input = Allocation.createFromBitmap(rs, blurredBitmap, Allocation.MipmapControl.MIPMAP_NONE,
                    Allocation.USAGE_SCRIPT);
            Allocation output = Allocation.createTyped(rs, input.getType());
            ScriptIntrinsicBlur blur = ScriptIntrinsicBlur.create(rs, Element.U8_4(rs));

            blur.setInput(input);
            blur.setRadius(radius);
            blur.forEach(output);
            output.copyTo(blurredBitmap);
            rs.destroy();
        } catch (RSRuntimeException e) {
            blurredBitmap = FastBlur.blur(blurredBitmap, radius, true);
        }
        return blurredBitmap;
    }
}
</code></pre><h2 id="16-动画处理"><a href="#16-动画处理" class="headerlink" title="16.动画处理"></a>16.动画处理</h2><p>通过animate()方法可以设置xml文件定义的4种补间动画(alpha、scale、translate、rotate)<br>例如:</p>
<p>res\anim\left_in.xml</p>
<pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
&lt;set xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;&gt;
    &lt;translate
        android:duration=&quot;@android:integer/config_mediumAnimTime&quot;
        android:fromXDelta=&quot;-50%p&quot;
        android:toXDelta=&quot;0&quot;/&gt;
    &lt;alpha
        android:duration=&quot;@android:integer/config_mediumAnimTime&quot;
        android:fromAlpha=&quot;0.0&quot;
        android:toAlpha=&quot;1.0&quot;/&gt;
&lt;/set&gt;
</code></pre><p>使用方式:  </p>
<pre><code>public class TestGlideActivity extends Activity {
    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_test);
        ImageView targetView = (ImageView) findViewById(R.id.iv_target);
        Glide.with(this).
                load(R.drawable.test).
                asBitmap().
                animate(R.anim.left_in).//加载xml文件定义的动画
                into(targetView);
    }
}
</code></pre><p>处理此外,还可以通过animate指定属性动画:</p>
<pre><code> public class TestGlideActivity extends Activity {
    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_test);
        ImageView targetView = (ImageView) findViewById(R.id.iv_target);

        ViewPropertyAnimation.Animator animationObject = new ViewPropertyAnimation.Animator() {
            @Override
            public void animate(View view) {
                //设置属性动画
                ObjectAnimator moveIn = ObjectAnimator.ofFloat(view, &quot;translationX&quot;, -500f, 0f);
                ObjectAnimator rotate = ObjectAnimator.ofFloat(view, &quot;rotation&quot;, 0f, 360f);
                ObjectAnimator fadeInOut = ObjectAnimator.ofFloat(view, &quot;alpha&quot;, 1f, 0f, 1f);
                ObjectAnimator moveTop = ObjectAnimator.ofFloat(view, &quot;translationY&quot;, 0f, -2000, 0f);
                AnimatorSet animSet = new AnimatorSet();
                //先左进,然后旋转伴随淡入效果,最后移动向上
                animSet.play(rotate).with(fadeInOut).after(moveIn).before(moveTop);
                animSet.setDuration(5000);
                animSet.start();
            }
        };
        Glide.with(this).
                load(R.drawable.test).
                asBitmap().
                animate(animationObject).//加载属性动画
                into(targetView);
    }
}
</code></pre><blockquote>
<p>我这里发现好像当调用了crossFade()方法，animate()方法定义的动画好像不会被调用，也就是没有效果。另外好像过渡动画只对ImageView对象有效果，当传入into()方法的参数为ViewTarget类型对象时，crossFade()和animate()好像都不会调用。这个还有待继续验证。  </p>
</blockquote>
<h2 id="17-回调：SimpleTarget和ViewTarget"><a href="#17-回调：SimpleTarget和ViewTarget" class="headerlink" title="17.回调：SimpleTarget和ViewTarget"></a>17.回调：SimpleTarget和ViewTarget</h2><p>Target接口代表Glide中资源最终被加载到的地方并且可以毁掉Glide中的生命周期方法。Target可以回调的生命周期方法有：  </p>
<ul>
<li>onLoadStarted</li>
<li>onResourceReady</li>
<li>onLoadCleared</li>
<li>onLoadFailed  </li>
</ul>
<p>典型的生命周期是：onLoadStarted -&gt; onResourceReady 或者 onLoadFailed -&gt; onLoadCleared。<br>实际可能某些方法不会调用，例如加入直接从内存缓存中加载资源，onLoadStarted方法便不会被调用了。<br>这里介绍两个Target实现类，同时也代表着两个常见的需求。<br><strong>有时候我们只是希望获得一张图片，而不想把它加载到什么地方上显示，对于这个需求使用SimpleTarget最合适不过了。</strong>  </p>
<pre><code>private SimpleTarget target = new SimpleTarget&lt;Bitmap&gt;() {  
    @Override
    public void onResourceReady(Bitmap bitmap, GlideAnimation glideAnimation) {

       //在这里我们就可以获得加载的资源了，当然这里是一个bitmap。
    }
};

private void loadImageSimpleTarget() {  
    Glide
        .with( context )
        .load( imageUrl)
        .asBitmap()
        .into( target ); //使用Target。
}
</code></pre><blockquote>
<p>这里有点要在强调一下，就是关于传给with()方法的context实例。要记得Glide的生命周期会和这个context实例的生命周期相绑定。所以可能会有这样的场景：在activityA中获得图片，你把这个activityA传给with()方法，然后还没获得图片，用户跳转到activityB，在activityB要显示这个图片。很显然activityA在回调onStop()的时候Glide也停止请求那张图片，所以在activityB中也就没有图片可显示啦。  </p>
</blockquote>
<p>还可以指定SimpleTarget获得的资源的尺寸：  </p>
<pre><code>private SimpleTarget target2 = new SimpleTarget&lt;Bitmap&gt;( 250, 250 ) {  
    @Override
    public void onResourceReady(Bitmap bitmap, GlideAnimation glideAnimation) {
        imageView2.setImageBitmap( bitmap );
    }
};  
</code></pre><p>另一个需求那就更常见了，而且也更迫切。<strong>当你自定义一个view的时候，同时这个view还不是继承ImageView但是ta也有显示图片的需要，怎么办？</strong>用ViewTarget来办：  </p>
<pre><code>//自定义的一个ViewGroup
public class CustomView extends FrameLayout {  
    ImageView iv;
    TextView tv;

    public void initialize(Context context) {
        inflate( context, R.layout.custom_view_, this );

        iv = (ImageView) findViewById( R.id.custom_view_image );
        tv = (TextView) findViewById( R.id.custom_view_text );
    }

    public CustomView(Context context, AttributeSet attrs) {
        super( context, attrs );
        initialize( context );
    }

    public CustomView(Context context, AttributeSet attrs, int defStyleAttr) {
        super( context, attrs, defStyleAttr );
        initialize( context );
    }

    public void setImage(Drawable drawable) {
        iv = (ImageView) findViewById( R.id.custom_view_image );

        iv.setImageDrawable( drawable );
    }
}

    CustomView customView = (CustomView) findViewById( R.id.custom_view );

    //定义一个ViewTarget，注意传入自定义View对象，还有ViewTarget的泛型。
    viewTarget = new ViewTarget&lt;CustomView, GlideDrawable&gt;( customView ) {
        @Override
        public void onResourceReady(GlideDrawable resource, GlideAnimation&lt;? super GlideDrawable&gt; glideAnimation) {
          //这里我们获得传入的自定义View，在这个自定义View中我们写了该View设置图片的方法。
            this.view.setImage( resource.getCurrent() );
        }
    };

    Glide
        .with( context.getApplicationContext() ) 
        .load( eatFoodyImages[2] )
        .into( viewTarget ); //使用Target。  
</code></pre><h2 id="18-调试和错误处理"><a href="#18-调试和错误处理" class="headerlink" title="18.调试和错误处理"></a>18.调试和错误处理</h2><p>可以使用ADB命令来查看资源请求时的日志：  </p>
<pre><code>adb shell setprop log.tag.GenericRequest DEBUG [还可选VERBOSE，INFO，WARN，ERROR日志级别]  
</code></pre><p>虽然有error()帮我们处理请求图片出错时的情况，但有时我们也想自己作一些处理，最起码得看看发生了什么是吧。用listener()注册一个RequestListener便可以得到请求资源时的一些关键回调方法：  </p>
<pre><code>private RequestListener&lt;String, GlideDrawable&gt; requestListener = new RequestListener&lt;String, GlideDrawable&gt;() {  
    @Override
    public boolean onException(Exception e, String model, Target&lt;GlideDrawable&gt; target, boolean isFirstResource) {
        //获得异常你想怎么处理随你的便利。
        return false;  //如果返回true，Glide认为你已经处理好了这个异常，那么error()方法也就不会调用了。
    }

    @Override
    public boolean onResourceReady(GlideDrawable resource, String model, Target&lt;GlideDrawable&gt; target, boolean isFromMemoryCache, boolean isFirstResource) {
        return false;
    }
};

Glide  
    .with( context )
    .load(UsageExampleListViewAdapter.eatFoodyImages[0])
    .listener( requestListener ) //注册监听器。
    .error( R.drawable.cupcake )
    .into( imageViewPlaceholder );  
</code></pre><p>当然Glide还有其它的监听器也很有用，例如LifecycleListener就可以在Glide里监听Fragment和Activity的onStart()、onStop()和onDestroy()回调。  </p>
<h2 id="19-集成自己的网络库"><a href="#19-集成自己的网络库" class="headerlink" title="19.集成自己的网络库"></a>19.集成自己的网络库</h2><p>你可以使用自己的网络库，但这个细讲起来还比较复杂。这里介绍当你的工程使用的是OkHttp或者Volley的情况，稍微配置一下build.gradle，其它什么都不用做了：  </p>
<pre><code>dependencies {  
    // 其它配置

    compile &apos;com.github.bumptech.glide:glide:3.7.0&apos;

    // 特别注意这个，就是ta让你可以使用OkHttp作为自己的网络请求库。
    compile &apos;com.github.bumptech.glide:okhttp-integration:1.4.0@aar&apos;
    compile &apos;com.squareup.okhttp:okhttp:2.7.5&apos;

    // 针对Volley的配置。
    //compile &apos;com.github.bumptech.glide:volley-integration:1.4.0@aar&apos;
    //compile &apos;com.mcxiaoke.volley:library:1.0.8&apos;

    // 针对OkHttp3的配置。
    //compile &apos;com.github.bumptech.glide:okhttp3-integration:1.4.0@aar&apos;
    //compile &apos;com.squareup.okhttp3:okhttp:3.2.0&apos;
}
</code></pre><blockquote>
<p><a href="http://www.androidchina.net/5022.html" target="_blank" rel="external">摘录来源</a></p>
</blockquote>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://ocnyang.com/2016/08/16/AndroidMPermission/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="OCN.Yang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/ocnyang.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="杨欧神/OCN.Yang">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/08/16/AndroidMPermission/" itemprop="url">
                  Android M 新的运行时权限开发者需要知道的一切
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-08-16T09:03:15+08:00">
                2016-08-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android教程系列/" itemprop="url" rel="index">
                    <span itemprop="name">Android教程系列</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/08/16/AndroidMPermission/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/08/16/AndroidMPermission/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2016/08/16/AndroidMPermission/" class="leancloud_visitors" data-flag-title="Android M 新的运行时权限开发者需要知道的一切">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Android-M-新的运行时权限开发者需要知道的一切"><a href="#Android-M-新的运行时权限开发者需要知道的一切" class="headerlink" title="Android M 新的运行时权限开发者需要知道的一切"></a>Android M 新的运行时权限开发者需要知道的一切</h1><p>android M 的名字官方刚发布不久，最终正式版即将来临！<br>android在不断发展，最近的更新 M 非常不同，一些主要的变化例如运行时权限将有颠覆性影响。惊讶的是android社区鲜有谈论这事儿，尽管这事很重要或许在不远的将来会引发很严重的问题。<br>这是今天我写这篇博客的原因。这里有一切关于android运行时权限你需要知道的，包括如何在代码中实现。现在亡羊补牢还不晚。  </p>
<h2 id="新运行时权限"><a href="#新运行时权限" class="headerlink" title="新运行时权限"></a>新运行时权限</h2><p>android的权限系统一直是首要的安全概念，因为这些权限只在安装的时候被询问一次。一旦安装了，app可以在用户毫不知晓的情况下访问权限内的所有东西。<br>难怪一些坏蛋利用这个缺陷恶意收集用户数据用来做坏事了！<br>android小组也知道这事儿。7年了！权限系统终于被重新设计了。在android6.0棉花糖，app将不会在安装的时候授予权限。取而代之的是，app不得不在运行时一个一个询问用户授予权限。  </p>
<p><img src="http://obbu6r1mi.bkt.clouddn.com/runtime_permissionruntimepermission.jpg" alt="">  </p>
<p>注意权限询问对话框不会自己弹出来。开发者不得不自己调用。如果开发者要调用的一些函数需要某权限而用户又拒绝授权的话，函数将抛出异常直接导致程序崩溃。  </p>
<p><img src="http://obbu6r1mi.bkt.clouddn.com/runtime_permissionruntimepermissioncrash.jpg" alt="">  </p>
<p>另外，用户也可以随时在设置里取消已经授权的权限。  </p>
<p><img src="http://obbu6r1mi.bkt.clouddn.com/runtime_permissionpermissionsrevoke.jpg" alt="">  </p>
<p>你或许已经感觉到背后生出一阵寒意。。。如果你是个android开发者，意味着要完全改变你的程序逻辑。你不能像以前那样直接调用方法了，你不得不为每个需要的地方检察权限，否则app就崩溃了！<br>是的。我不能哄你说这是简单的事儿。尽管这对用户来说是好事，但是对开发者来说就是噩梦。我们不得不修改编码不然不论短期还是长远来看都是潜在的问题。<br>这个新的运行时权限仅当我们设置targetSdkVersion to 23（这意味着你已经在23上测试通过了）才起作用，当然还要是M系统的手机。app在6.0之前的设备依然使用旧的权限系统。</p>
<h2 id="已经发布了的app会发生什么"><a href="#已经发布了的app会发生什么" class="headerlink" title="已经发布了的app会发生什么"></a>已经发布了的app会发生什么</h2><blockquote>
<p>新运行时权限可能已经让你开始恐慌了。<strong>“hey，伙计！我三年前发布的app可咋整呢。如果他被装到android 6.0上，我的app会崩溃吗？！？”</strong><br>莫慌张，放轻松。android小队又不傻，肯定考虑到了这情况。<strong>如果app的targetSdkVersion 低于 23，那将被认为app没有用23新权限测试过，那将被继续使用旧有规则：用户在安装的时候不得不接受所有权限，安装后app就有了那些权限咯！</strong>  </p>
</blockquote>
<p><img src="http://obbu6r1mi.bkt.clouddn.com/mpermission22_1%20%281%29.jpg" alt="">  </p>
<p>然后app像以前一样奔跑！注意，此时用户依然可以取消已经同意的授权！用户取消授权时，android 6.0系统会警告，但这不妨碍用户取消授权。  </p>
<p><img src="http://obbu6r1mi.bkt.clouddn.com/runtime_permissionmpermission22denyperm_1.jpg" alt="">  </p>
<p>问题又来了，这时候你的app崩溃吗？<br>善意的主把这事也告诉了android小组，当我们在targetSdkVersion 低于23的app调用一个需要权限的函数时，这个权限如果被用户取消授权了的话，不抛出异常。但是他将啥都不干，结果导致函数返回值是null或者0.  </p>
<p><img src="http://obbu6r1mi.bkt.clouddn.com/runtime_permissiontargetsdkversion2223.jpg" alt="">  </p>
<p>别高兴的太早。尽管app不会调用这个函数时崩溃，返回值null或者0可能接下来依然导致崩溃。<br>好消息（至少目前看来）是这类取消权限的情况比较少，我相信很少用户这么搞。如果他们这么办了，后果自负咯。<br>但从长远看来，我相信还是会有大量用户会关闭一些权限。我们app不能在新设备完美运行这是不可接受的。<br>怎样让他完美运行呢，你最好修改代码支持最新的权限系统，而且我建议你立刻着手搞起！<br>代码没有成功改为支持最新运行时权限的app,不要设置targetSdkVersion 23 发布，否则你就有麻烦了。只有当你测试过了，再改为targetSdkVersion 23 。  </p>
<blockquote>
<p><strong>警告：现在你在android studio新建项目，targetSdkVersion 会自动设置为 23。如果你还没支持新运行时权限，我建议你首先把targetSdkVersion 降级到22</strong>  </p>
</blockquote>
<h2 id="PROTECTION-NORMAL类权限"><a href="#PROTECTION-NORMAL类权限" class="headerlink" title="PROTECTION_NORMAL类权限"></a>PROTECTION_NORMAL类权限</h2><p>当用户安装或更新应用时，系统将授予应用所请求的属于 PROTECTION_NORMAL 的所有权限（安装时授权的一类基本权限）。这类权限包括：  </p>
<pre><code>android.permission.ACCESS_LOCATION_EXTRA_COMMANDS
android.permission.ACCESS_NETWORK_STATE
android.permission.ACCESS_NOTIFICATION_POLICY
android.permission.ACCESS_WIFI_STATE
android.permission.ACCESS_WIMAX_STATE
android.permission.BLUETOOTH
android.permission.BLUETOOTH_ADMIN
android.permission.BROADCAST_STICKY
android.permission.CHANGE_NETWORK_STATE
android.permission.CHANGE_WIFI_MULTICAST_STATE
android.permission.CHANGE_WIFI_STATE
android.permission.CHANGE_WIMAX_STATE
android.permission.DISABLE_KEYGUARD
android.permission.EXPAND_STATUS_BAR
android.permission.FLASHLIGHT
android.permission.GET_ACCOUNTS
android.permission.GET_PACKAGE_SIZE
android.permission.INTERNET
android.permission.KILL_BACKGROUND_PROCESSES
android.permission.MODIFY_AUDIO_SETTINGS
android.permission.NFC
android.permission.READ_SYNC_SETTINGS
android.permission.READ_SYNC_STATS
android.permission.RECEIVE_BOOT_COMPLETED
android.permission.REORDER_TASKS
android.permission.REQUEST_INSTALL_PACKAGES
android.permission.SET_TIME_ZONE
android.permission.SET_WALLPAPER
android.permission.SET_WALLPAPER_HINTS
android.permission.SUBSCRIBED_FEEDS_READ
android.permission.TRANSMIT_IR
android.permission.USE_FINGERPRINT
android.permission.VIBRATE
android.permission.WAKE_LOCK
android.permission.WRITE_SYNC_SETTINGS
com.android.alarm.permission.SET_ALARM
com.android.launcher.permission.INSTALL_SHORTCUT
com.android.launcher.permission.UNINSTALL_SHORTCUT
</code></pre><p>只需要在AndroidManifest.xml中简单声明这些权限就好，安装时就授权。不需要每次使用时都检查权限，而且用户不能取消以上授权。  </p>
<h2 id="让你的app支持新运行时权限"><a href="#让你的app支持新运行时权限" class="headerlink" title="让你的app支持新运行时权限"></a>让你的app支持新运行时权限</h2><p>是时候让我们的app支持新权限模型了，从设置<strong>compileSdkVersion</strong> and <strong>targetSdkVersion</strong> 为 23开始吧.</p>
<pre><code>android {
    compileSdkVersion 23
    ...

    defaultConfig {
        ...
        targetSdkVersion 23
        ...
    }
</code></pre><p>例子，我想用以下方法添加联系人。</p>
<pre><code>privatestaticfinal String TAG = &quot;Contacts&quot;;
privatevoid insertDummyContact() {
// Two operations are needed to insert a new contact.
    ArrayList operations = new ArrayList(2);

// First, set up a new raw contact.
    ContentProviderOperation.Builder op =
            ContentProviderOperation.newInsert(ContactsContract.RawContacts.CONTENT_URI)
                    .withValue(ContactsContract.RawContacts.ACCOUNT_TYPE, null)
                    .withValue(ContactsContract.RawContacts.ACCOUNT_NAME, null);
    operations.add(op.build());

// Next, set the name for the contact.
    op = ContentProviderOperation.newInsert(ContactsContract.Data.CONTENT_URI)
            .withValueBackReference(ContactsContract.Data.RAW_CONTACT_ID, 0)
            .withValue(ContactsContract.Data.MIMETYPE,
                    ContactsContract.CommonDataKinds.StructuredName.CONTENT_ITEM_TYPE)
            .withValue(ContactsContract.CommonDataKinds.StructuredName.DISPLAY_NAME,
&quot;__DUMMY CONTACT from runtime permissions sample&quot;);
    operations.add(op.build());

// Apply the operations.
    ContentResolver resolver = getContentResolver();
try {
        resolver.applyBatch(ContactsContract.AUTHORITY, operations);
    } catch (RemoteException e) {
        Log.d(TAG, &quot;Could not add a new contact: &quot; + e.getMessage());
    } catch (OperationApplicationException e) {
        Log.d(TAG, &quot;Could not add a new contact: &quot; + e.getMessage());
    }
}
</code></pre><p>上面代码需要WRITE_CONTACTS权限。如果不询问授权，app就崩了。<br>下一步像以前一样在AndroidManifest.xml添加声明权限。</p>
<pre><code>&lt;uses-permission  android:name=&quot;android.permission.WRITE_CONTACTS&quot;/&gt;
</code></pre><p>下一步，不得不再写个方法检查有没有权限。如果没有弹个对话框询问用户授权。然后你才可以下一步创建联系人。<br>权限被分组了，如下表：  </p>
<p><img src="http://obbu6r1mi.bkt.clouddn.com/runtime_permissionpermgroup.png" alt="">  </p>
<p>同一组的任何一个权限被授权了，其他权限也自动被授权。例如，一旦WRITE_CONTACTS被授权了，app也有READ_CONTACTS和GET_ACCOUNTS权限了。<br>源码中被用来检查和请求权限的方法分别是Activity的checkSelfPermission和requestPermissions。这些方法在api23引入。</p>
<pre><code>finalprivateint REQUEST_CODE_ASK_PERMISSIONS = 123;

privatevoid insertDummyContactWrapper() {
int hasWriteContactsPermission = checkSelfPermission(Manifest.permission.WRITE_CONTACTS);
if (hasWriteContactsPermission != PackageManager.PERMISSION_GRANTED) {
        requestPermissions(new String[] {Manifest.permission.WRITE_CONTACTS},
                REQUEST_CODE_ASK_PERMISSIONS);
return;
    }
    insertDummyContact();
}
</code></pre><p>如果已有权限，insertDummyContact()会执行。否则，requestPermissions被执行来弹出请求授权对话框，如下：</p>
<p>不论用户同意还是拒绝，activity的onRequestPermissionsResult会被回调来通知结果（通过第三个参数），grantResults,如下：</p>
<pre><code>@Override
publicvoid onRequestPermissionsResult(int requestCode, String[] permissions, int[] grantResults) {
switch (requestCode) {
caseREQUEST_CODE_ASK_PERMISSIONS:
if (grantResults[0] == PackageManager.PERMISSION_GRANTED) {
// Permission Granted
                insertDummyContact();
            } else {
// Permission Denied
                Toast.makeText(MainActivity.this, &quot;WRITE_CONTACTS Denied&quot;, Toast.LENGTH_SHORT)
                        .show();
            }
break;
        default:
super.onRequestPermissionsResult(requestCode, permissions, grantResults);
    }
}
</code></pre><p>这就是新权限模型工作过程。代码真复杂但是只能去习惯它。。。为了让app很好兼容新权限模型，你不得不用以上类似方法处理所有需要的情况。<br>如果你想捶墙，现在是时候了。。。  </p>
<h2 id="处理-“不再提醒”"><a href="#处理-“不再提醒”" class="headerlink" title="处理 “不再提醒”"></a>处理 “不再提醒”</h2><p>如果用户拒绝某授权。下一次弹框，用户会有一个“不再提醒”的选项的来防止app以后继续请求授权。  </p>
<p><img src="http://obbu6r1mi.bkt.clouddn.com/runtime_permissionneveraskagain.jpg" alt="">  </p>
<p>如果这个选项在拒绝授权前被用户勾选了。下次为这个权限请求requestPermissions时，对话框就不弹出来了，结果就是，app啥都不干。<br>这将是很差的用户体验，用户做了操作却得不到响应。这种情况需要好好处理一下。在请求requestPermissions前，我们通过activity的shouldShowRequestPermissionRationale方法来检查是否需要弹出请求权限的提示对话框，代码如下：</p>
<pre><code>final private int REQUEST_CODE_ASK_PERMISSIONS = 123;

private void insertDummyContactWrapper() {
int hasWriteContactsPermission = checkSelfPermission(Manifest.permission.WRITE_CONTACTS);
if (hasWriteContactsPermission != PackageManager.PERMISSION_GRANTED) {
if (!shouldShowRequestPermissionRationale(Manifest.permission.WRITE_CONTACTS)) {
                showMessageOKCancel(&quot;You need to allow access to Contacts&quot;,
new DialogInterface.OnClickListener() {
@Override
publicvoid onClick(DialogInterface dialog, int which) {
                                requestPermissions(new String[] {Manifest.permission.WRITE_CONTACTS},
                                        REQUEST_CODE_ASK_PERMISSIONS);
                            }
                        });
return;
            }
        requestPermissions(new String[] {Manifest.permission.WRITE_CONTACTS},
                REQUEST_CODE_ASK_PERMISSIONS);
return;
    }
    insertDummyContact();
}

private void showMessageOKCancel(String message, DialogInterface.OnClickListener okListener) {
new AlertDialog.Builder(MainActivity.this)
            .setMessage(message)
            .setPositiveButton(&quot;OK&quot;, okListener)
            .setNegativeButton(&quot;Cancel&quot;, null)
            .create()
            .show();
}
</code></pre><p>当一个权限第一次被请求和用户标记过不再提醒的时候,我们写的对话框被展示。<br>最后一种情况，onRequestPermissionsResult 会收到PERMISSION_DENIED ，系统询问对话框不展示。  </p>
<p><img src="http://obbu6r1mi.bkt.clouddn.com/runtime_permissionrationaledialog.jpg" alt="">  </p>
<p>搞定！  </p>
<h2 id="一次请求多个权限"><a href="#一次请求多个权限" class="headerlink" title="一次请求多个权限"></a>一次请求多个权限</h2><p>当然了有时候需要好多权限，可以用上面方法一次请求多个权限。不要忘了为每个权限检查“不再提醒”的设置。<br>修改后的代码：</p>
<pre><code>final private int REQUEST_CODE_ASK_MULTIPLE_PERMISSIONS = 124;

private void insertDummyContactWrapper() {
    List&lt;String&gt; permissionsNeeded = new ArrayList&lt;String&gt;();

    final List&lt;String&gt; permissionsList = new ArrayList&lt;String&gt;();
    if (!addPermission(permissionsList, Manifest.permission.ACCESS_FINE_LOCATION))
        permissionsNeeded.add(&quot;GPS&quot;);
    if (!addPermission(permissionsList, Manifest.permission.READ_CONTACTS))
        permissionsNeeded.add(&quot;Read Contacts&quot;);
    if (!addPermission(permissionsList, Manifest.permission.WRITE_CONTACTS))
        permissionsNeeded.add(&quot;Write Contacts&quot;);

    if (permissionsList.size() &gt; 0) {
        if (permissionsNeeded.size() &gt; 0) {
            // Need Rationale
            String message = &quot;You need to grant access to &quot; + permissionsNeeded.get(0);
            for (int i = 1; i &lt; permissionsNeeded.size(); i++)
                message = message + &quot;, &quot; + permissionsNeeded.get(i);
            showMessageOKCancel(message,
                    new DialogInterface.OnClickListener() {
                        @Override
                        public void onClick(DialogInterface dialog, int which) {
                            requestPermissions(permissionsList.toArray(new String[permissionsList.size()]),
                                    REQUEST_CODE_ASK_MULTIPLE_PERMISSIONS);
                        }
                    });
            return;
        }
        requestPermissions(permissionsList.toArray(new String[permissionsList.size()]),
                REQUEST_CODE_ASK_MULTIPLE_PERMISSIONS);
        return;
    }

    insertDummyContact();
}

private boolean addPermission(List&lt;String&gt; permissionsList, String permission) {
    if (checkSelfPermission(permission) != PackageManager.PERMISSION_GRANTED) {
        permissionsList.add(permission);
        // Check for Rationale Option
        if (!shouldShowRequestPermissionRationale(permission))
            return false;
    }
    return true;
}
</code></pre><p>如果所有权限被授权，依然回调onRequestPermissionsResult，我用hashmap让代码整洁便于阅读。</p>
<pre><code>@Override
publicvoid onRequestPermissionsResult(int requestCode, String[] permissions, int[] grantResults) {
switch (requestCode) {
caseREQUEST_CODE_ASK_MULTIPLE_PERMISSIONS:
            {
            Map perms = new HashMap();
// Initial
            perms.put(Manifest.permission.ACCESS_FINE_LOCATION, PackageManager.PERMISSION_GRANTED);
            perms.put(Manifest.permission.READ_CONTACTS, PackageManager.PERMISSION_GRANTED);
            perms.put(Manifest.permission.WRITE_CONTACTS, PackageManager.PERMISSION_GRANTED);
// Fill with results
for (int i = 0; i &lt; permissions.length; i++)
                perms.put(permissions[i], grantResults[i]);
// Check for ACCESS_FINE_LOCATION
if (perms.get(Manifest.permission.ACCESS_FINE_LOCATION) == PackageManager.PERMISSION_GRANTED
                    &amp;&amp; perms.get(Manifest.permission.READ_CONTACTS) == PackageManager.PERMISSION_GRANTED
                    &amp;&amp; perms.get(Manifest.permission.WRITE_CONTACTS) == PackageManager.PERMISSION_GRANTED) {
// All Permissions Granted
                insertDummyContact();
            } else {
// Permission Denied
                Toast.makeText(MainActivity.this, &quot;Some Permission is Denied&quot;, Toast.LENGTH_SHORT)
                        .show();
            }
            }
break;
        default:
super.onRequestPermissionsResult(requestCode, permissions, grantResults);
    }
}
</code></pre><p>条件灵活的，你自己设置。有的情况，一个权限没有授权，就不可用；但是也有情况，能工作，但是表现的是有所限制的。对于这个我不做评价，你自己设计吧。  </p>
<h2 id="用兼容库使代码兼容旧版"><a href="#用兼容库使代码兼容旧版" class="headerlink" title="用兼容库使代码兼容旧版"></a>用兼容库使代码兼容旧版</h2><p>以上代码在android 6.0以上运行没问题，但是23 api之前就不行了，因为没有那些方法。<br>粗暴的方法是检查版本</p>
<pre><code>if (Build.VERSION.SDK_INT &gt;= 23) {
// Marshmallow+
} else {
// Pre-Marshmallow
}
</code></pre><p>但是太复杂，我建议用v4兼容库，已对这个做过兼容，用这个方法代替：  </p>
<ul>
<li>ContextCompat.checkSelfPermission()<br>  被授权函数返回PERMISSION_GRANTED，否则返回PERMISSION_DENIED ，在所有版本都是如此。</li>
<li>ActivityCompat.requestPermissions()<br>  这个方法在M之前版本调用，OnRequestPermissionsResultCallback 直接被调用，带着正确的 PERMISSION_GRANTED或者 PERMISSION_DENIED 。</li>
<li>ActivityCompat.shouldShowRequestPermissionRationale()<br>  在M之前版本调用，永远返回false。<br>  用v4包的这三方法，完美兼容所有版本！这个方法需要额外的参数，Context or Activity。别的就没啥特别的了。下面是代码：<br>&gt;</li>
</ul>
<pre><code>private void insertDummyContactWrapper(){
int hasWriteContactsPermission = ContextCompat.checkSelfPermission(MainActivity.this,
            Manifest.permission.WRITE_CONTACTS);
if (hasWriteContactsPermission != PackageManager.PERMISSION_GRANTED) {
if (!ActivityCompat.shouldShowRequestPermissionRationale(MainActivity.this,
                Manifest.permission.WRITE_CONTACTS)) {
            showMessageOKCancel(&quot;You need to allow access to Contacts&quot;,
new DialogInterface.OnClickListener() {
@Override
publicvoidonClick(DialogInterface dialog, int which){
                            ActivityCompat.requestPermissions(MainActivity.this,
new String[] {Manifest.permission.WRITE_CONTACTS},
                                    REQUEST_CODE_ASK_PERMISSIONS);
                        }
                    });
return;
        }
        ActivityCompat.requestPermissions(MainActivity.this,
new String[] {Manifest.permission.WRITE_CONTACTS},
                REQUEST_CODE_ASK_PERMISSIONS);
return;
    }
    insertDummyContact();
}  
</code></pre><p>后两个方法，我们也可以在Fragment中使用，用v13兼容包：FragmentCompat.requestPermissions() and FragmentCompat.shouldShowRequestPermissionRationale()和activity效果一样。  </p>
<h2 id="第三方库简化代码"><a href="#第三方库简化代码" class="headerlink" title="第三方库简化代码"></a>第三方库简化代码</h2><p>以上代码真尼玛复杂。为解决这事，有许多第三方库已经问世了，真66溜真有速度。我试了很多最终找到了个满意的<a href="https://github.com/hotchemi/PermissionsDispatcher" target="_blank" rel="external">hotchemi’s PermissionsDispatcher</a>。<br>他和我上面做的一样，只是简化了代码。灵活易扩展，试一下吧。如果不满足你可以找些其他的。  </p>
<h2 id="如果我的app还开着呢，权限被撤销了，会发生生么"><a href="#如果我的app还开着呢，权限被撤销了，会发生生么" class="headerlink" title="如果我的app还开着呢，权限被撤销了，会发生生么"></a>如果我的app还开着呢，权限被撤销了，会发生生么</h2><p>权限随时可以被撤销。  </p>
<p><img src="http://obbu6r1mi.bkt.clouddn.com/runtime_permissionpermissionsrevoke%20%281%29.jpg" alt="">  </p>
<p>当app开着的时候被撤消了会发生什么呢？我试过了发现这时app会突然终止 terminated。app中的一切都被简单粗暴的停止了，因为terminated！对我来说这可以理解，因为系统如果允许它继续运行（没有某权限），这会召唤弗雷迪到我的噩梦里。或许更糟…  </p>
<h2 id="结论建议"><a href="#结论建议" class="headerlink" title="结论建议"></a>结论建议</h2><p>我相信你对新权限模型已经有了清晰的认识。我相信你也意识到了问题的严峻。<br>但是你没得选择。新运行时权限已经在棉花糖中被使用了。我们没有退路。我们现在唯一能做的就是保证app适配新权限模型.<br>欣慰的是只有少数权限需要运行时权限模型。大多数常用的权限，例如，网络访问，属于Normal Permission 在安装时自动会授权，当然你要声明，以后无需检查。因此，只有少部分代码你需要修改。<br>两个建议：  </p>
<ol>
<li>严肃对待新权限模型</li>
<li>如果你代码没支持新权限，不要设置targetSdkVersion 23 。尤其是当你在Studio新建工程时，不要忘了修改！  </li>
</ol>
<p>说一下代码修改。这是大事，如果代码结构被设计的不够好，你需要一些很蛋疼的重构。每个app都要被修正。如上所说，我们没的选择。。。<br>列出所有你需要请求的权限所有情形，如果A被授权，B被拒绝，会发生什么。blah，blah。<br>祝重构顺利。把它列为你需要做的大事，从现在就开始着手做，以保证M正式发布的时候没有问题。<br>希望本文对你有用，快乐编码！  </p>
<blockquote>
<p>译文来自 <em><a href="http://inthecheesefactory.com/blog/things-you-need-to-know-about-android-m-permission-developer-edition/en" target="_blank" rel="external">http://inthecheesefactory.com/blog/things-you-need-to-know-about-android-m-permission-developer-edition/en</a></em><br>翻译摘录来自 <em><a href="http://jijiaxin89.com/2015/08/30/Android-s-Runtime-Permission/" target="_blank" rel="external">http://jijiaxin89.com/2015/08/30/Android-s-Runtime-Permission/</a></em>  </p>
</blockquote>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://ocnyang.com/2016/08/16/Android6Permission/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="OCN.Yang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/ocnyang.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="杨欧神/OCN.Yang">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/08/16/Android6Permission/" itemprop="url">
                  在Android 6.0 设备上动态获取权限
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-08-16T08:03:15+08:00">
                2016-08-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android教程系列/" itemprop="url" rel="index">
                    <span itemprop="name">Android教程系列</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/08/16/Android6Permission/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/08/16/Android6Permission/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2016/08/16/Android6Permission/" class="leancloud_visitors" data-flag-title="在Android 6.0 设备上动态获取权限">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="在Android-6-0-设备上动态获取权限"><a href="#在Android-6-0-设备上动态获取权限" class="headerlink" title="在Android 6.0 设备上动态获取权限"></a>在Android 6.0 设备上动态获取权限</h1><p>众所周知，Android 6.0 相比之前的Android版本有一个很大的不同点，就是动态获取权限。今天自己在做拨号功能时，正巧遇到这个问题， 顺手记录下在Android 6.0 上如何动态获取权限。</p>
<p>下面从自己一开始的问题入手</p>
<h3 id="实现拨号功能"><a href="#实现拨号功能" class="headerlink" title="实现拨号功能"></a>实现拨号功能</h3><p>说到拨号，一个 Intent 就搞定，代码如下，</p>
<pre><code>private void callDirectly(String mobile){
     Intent intent = new Intent();
     intent.setAction(&quot;android.intent.action.CALL&quot;);
     intent.setData(Uri.parse(&quot;tel:&quot; + mobile));
     mContext.startActivity(intent);
 }
</code></pre><p>当然 你可别忘了在 Manifest 文件中去声明拨号的权限</p>
<pre><code>&lt;uses-permission android:name=&quot;android.permission.CALL_PHONE&quot; /&gt;
</code></pre><h3 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h3><p>如果在 Android 6.0 以前的设备上，上面的代码都是没有问题的，但是如果是在 Android 6.0 设备上，并且项目的 targetSdkVersion 你设置的是23，那么 当你执行上面的拨号代码时，程序将会奔溃掉。</p>
<p>此时你肯定想到了 如果 targetSdkVersion 值设置的小于23是不是就不会奔溃了，恩，确实如此， 此时即使使用Android6.0的设备，程序也不会奔溃，原因显而易见，Android 的权限机制是 Android M 后才加入的。从 Android M 开始 应用程序申请的权限是在运行时动态赋给用户的。</p>
<p>关于动态分配权限，一些同学可能不是很清楚。这里稍稍提一下 Android 6.0 的权限动态分配。 如果你只对最终的解决方案感兴趣，可以跳过下面这节，直接去看解决方案</p>
<h3 id="权限动态分配"><a href="#权限动态分配" class="headerlink" title="权限动态分配"></a>权限动态分配</h3><p>在 Android6.0 之前，下载好一个应用程序，点击安装我们看到的大都是像这样的界面。  </p>
<p><img src="http://obbu6r1mi.bkt.clouddn.com/android_m_install.jpg" alt="">  </p>
<p>上图分别是Nexus6和小米手机在安装软件时的界面。</p>
<p>在安装时你会发现，手机操作系统会提示，这个软件会索要了你手机的那些权限，并且给用一个列表进行展示，但是这些提示只是在安装是提示，只要你点击接受或者安装， 表示你允许这个应用在可以获取它申明的所有权限。一般很少有人在安装时，会因为看到某个应用因为申请了某一个敏感权限而放弃安装应用。因为这个权限虽然敏感， 但是对于当前的用户是不可感知的，因为他现在并没有立即去查看你的最近通话、短信记录…</p>
<p>说到这里，我们自然而然的会想到，其实最好的方式是，当这个应用在用户使用过程中，正准备使用某个权限时，比如说读取短信列表，系统能及时的弹出一个提示框，说这个应用要读取您的短信内容， 您是否允许。然后用户结合当前应用的执行动作，依据当前条件判断，是不是应该授予应用读取短信记录的权限。这绝对的最完美的。 因为在具体的使用过程中，用户可以结合当前应用的使用场景，去思考、判断是不是应该给这个应用相应的权限。不给能怎样，给了会怎样， 这样对用户而言，完全是主动的，相比安装时那种选择，这样的做法无疑是对用户莫大的尊重，同时这也保证了用户的个人隐私。</p>
<p>说到这里，不得不插一句，其实 MIUI 早就实现了这个系统特性，在这一点上 MIUI 确实走到了 Android团队的前面，恩，给 MIUI 点个赞。</p>
<p>然而直到 Android 6.0 这个版本开始，上面的假设终于得到了谷歌的实践，除了在应用安装时，操作系统会提示应用会获取那些权限，在运行过程中，当应用去真的获取一些敏感 权限时，系统还会弹出一个提示框，询问用户是不是授予应用相应的权限。如下图所示。  </p>
<p><img src="http://obbu6r1mi.bkt.clouddn.com/android_m_sms.jpeg" alt="">  </p>
<p>这就是 Android 6.0 的运行时权限检查机制。下面是Google官方对此的解释，只截取介绍部分</p>
<blockquote>
<p>Beginning in Android 6.0 (API level 23), users grant permissions to apps while the app is running, not when they install the app. This approach streamlines the app install process, since the user does not need to grant permissions when they install or update the app. It also gives the user more control over the app’s functionality; for example, a user could choose to give a camera app access to the camera but not to the device location. The user can revoke the permissions at any time, by going to the app’s Settings screen.</p>
</blockquote>
<h3 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h3><p>其实上面已经说了一种取巧的方案，将 targetSdkVersion 设为小于23的值，程序将不会奔溃， 但是在Android 6.0 上你的应用程序依旧拨不了电话，这是真的。所以要想兼容6.0版本，必须通过下面的方式进行代码层面的兼容。</p>
<p>对Android版本做判断，然后对Android 6.0 做特殊处理，代码如下</p>
<pre><code>final public static int REQUEST_CODE_ASK_CALL_PHONE = 123;

public void onCall(String mobile){
       this.mMobile = mobile;
       if (Build.VERSION.SDK_INT &gt;= 23) {
           int checkCallPhonePermission = ContextCompat.checkSelfPermission(mContext,Manifest.permission.CALL_PHONE);
           if(checkCallPhonePermission != PackageManager.PERMISSION_GRANTED){
               ActivityCompat.requestPermissions(mContext,new String[]{Manifest.permission.CALL_PHONE},REQUEST_CODE_ASK_CALL_PHONE);
               return;
           }else{
               //上面已经写好的拨号方法
               callDirectly(mobile);
           }
       } else {
           //上面已经写好的拨号方法
           callDirectly(mobile);
       }
   }
</code></pre><p>此时，如果一个Android6.0的用户触发拨号动作，执行上面的代码，那么他将会看到一个很好看的MaterialDialog，如下图所示。</p>
<p><img src="http://obbu6r1mi.bkt.clouddn.com/android_m_permission.jpeg" alt=""></p>
<p>那么用户点击拒绝或者允许，我们怎么才能拿到回调呢，如果能拿到回调，我们就可以根据用户的选择来执行不同的操作了。</p>
<p>这里应该会看到在 ActivityCompat 的 requestPermissions 方法中，最后一个参数是一个requestCode，看到它自然而然想到了经常用到的onActivityResult， 这里当执行 ActivityCompat 的 requestPermissions 方法后有一个回调机制，需要我们在当前 Activity 中实现 onRequestPermissionsResult 这个方法，具体如下</p>
<pre><code>@Override
public void onRequestPermissionsResult(int requestCode, String[] permissions, int[] grantResults) {
    switch (requestCode) {
        case REQUEST_CODE_ASK_CALL_PHONE:
            if (grantResults[0] == PackageManager.PERMISSION_GRANTED) {
                // Permission Granted
                callDirectly(mobile);
            } else {
                // Permission Denied
                Toast.makeText(MainActivity.this, &quot;CALL_PHONE Denied&quot;, Toast.LENGTH_SHORT)
                        .show();
            }
            break;
        default:
            super.onRequestPermissionsResult(requestCode, permissions, grantResults);
    }
}
</code></pre><p>这里会对提供了一个对用户点击做判断的入口，开发者可以根据 grantResults[0] 的类型，来判断用户点击的是允许还是拒绝，接着就可以执行相应的逻辑了。</p>
<h3 id="有用的链接"><a href="#有用的链接" class="headerlink" title="有用的链接"></a>有用的链接</h3><p>关于AndroidM上权限的动态获取，这里只给出了一个最简单的示例，如果你还没有尽兴，那么下面这篇国外的博文，一定会让你满足。</p>
<p><a href="https://inthecheesefactory.com/blog/things-you-need-to-know-about-android-m-permission-developer-edition/en" target="_blank" rel="external">Everything every Android Developer must know about new Android’s Runtime Permission</a></p>
<p>这篇英文博文内容很长、内容也比较多，十足的干货。您慢用~</p>
<p>后记：偶然发现已经有哥们把上面的这篇文章做了翻译，真是极好的，这里给大家也摘录过来了，附上<strong><a href="http://ocnyang.com/2016/08/16/AndroidMPermission/">翻译链接</a></strong>，给翻译者同学点赞，辛苦！</p>
<p>另外，最近看到一个Github上的开源项目 <a href="https://github.com/k0shk0sh/PermissionHelper" target="_blank" rel="external">PermissionHelper</a> ，专门用于处理 Android 6.0 的权限兼容问题。  </p>
<blockquote>
<p><a href="http://gudong.name/%E6%8A%80%E6%9C%AF/2015/11/10/android_m_permission.html" target="_blank" rel="external">摘录来源</a></p>
</blockquote>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://ocnyang.com/2016/08/15/GetPhotoThreeMethods/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="OCN.Yang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/ocnyang.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="杨欧神/OCN.Yang">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/08/15/GetPhotoThreeMethods/" itemprop="url">
                  获取图片的三种方法（超完整）
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-08-15T18:03:15+08:00">
                2016-08-15
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android教程系列/" itemprop="url" rel="index">
                    <span itemprop="name">Android教程系列</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/08/15/GetPhotoThreeMethods/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/08/15/GetPhotoThreeMethods/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2016/08/15/GetPhotoThreeMethods/" class="leancloud_visitors" data-flag-title="获取图片的三种方法（超完整）">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Android获取图片的三种方法（超完整）"><a href="#Android获取图片的三种方法（超完整）" class="headerlink" title="Android获取图片的三种方法（超完整）"></a>Android获取图片的三种方法（超完整）</h1><blockquote>
<p>本文导航  </p>
<ul>
<li>Camera的源码分析  </li>
<li>获取Camera的缩略图  </li>
<li>获取Camera的完整图片  </li>
<li>获取Gallery的图片  </li>
</ul>
</blockquote>
<h2 id="源码部分分析"><a href="#源码部分分析" class="headerlink" title="源码部分分析"></a>源码部分分析</h2><p><a href="https://github.com/android/platform_packages_apps_camera/blob/gingerbread-release/src/com/android/camera/Camera.java#L1127" target="_blank" rel="external">Camera.java</a></p>
<p>通过源码可以发现，输出的图片有2个分支</p>
<ol>
<li><p>如果你没有指定Intent里面的Extra参数，它就返回一个序列化(putExtra(“data”, bitmap))的Bitmap，从理论上来说，这样的代码写的很烂，属于Magic Number。</p>
</li>
<li><p>如果你指定了Intent里面的Extra参数MediaStore.EXTRA_OUTPUT，拍照后它就直接把bitmap写到了Uri里面了,返回是空</p>
</li>
</ol>
<h2 id="获得拍照的预览图"><a href="#获得拍照的预览图" class="headerlink" title="获得拍照的预览图"></a>获得拍照的预览图</h2><p>使用范围：获得很小的预览图，用于设置头像等地方。<br>返回示例：bitmap = data.getExtras().getParcelable(“data”);</p>
<pre><code>public final static int REQUEST_IMAGE_CAPTURE = 1;

//start
Intent intent = new Intent(android.provider.MediaStore.ACTION_IMAGE_CAPTURE);
startActivityForResult(intent, REQUEST_IMAGE_CAPTURE);

//receive
@Override protected void onActivityResult(int requestCode, int resultCode, Intent data) {
    super.onActivityResult(requestCode, resultCode, data);
    if (resultCode != RESULT_OK) {
      Log.d(TAG, &quot;canceled or other exception!&quot;);
      return;
    }

    if (requestCode == REQUEST_IMAGE_CAPTURE) {
      Log.d(TAG, &quot;REQUEST_IMAGE_CAPTURE&quot;);
      Bitmap bitmap;
      try {
          //&quot;data&quot;这个居然没用常量定义,也是醉了,我们可以发现它直接把bitmap序列化到intent里面了。
        bitmap = data.getExtras().getParcelable(&quot;data&quot;); 
        //TODO:do something with bitmap, Do NOT forget call Bitmap.recycler();
        mCameraImageview.setImageBitmap(bitmap);
      } catch (ClassCastException e){
           //do something with exceptions
        e.printStackTrace();
      } 
    }

  }
</code></pre><h2 id="获得原始的拍照文件"><a href="#获得原始的拍照文件" class="headerlink" title="获得原始的拍照文件"></a>获得原始的拍照文件</h2><p>使用范围：用于处理大的图片，比如使用滤镜，上传原始图像等操作，注意Uri不要用data私有目录，否则相机是写不进去的。</p>
<p>返回示例:</p>
<pre><code>outputFileUri = file:///storage/sdcard0/JPEG_20150226_221320_-328629202.jpg
</code></pre><p>使用方法：</p>
<pre><code>public final static int REQUEST_IMAGE_CAPTURE = 1;
Uri outputFileUri;

//start
  @OnClick(R.id.itemSelectCamera) void itemSelectCamera() {
    File file = FileUtils.createImageFile();
    outputFileUri = Uri.fromFile(file);
    Intent captureIntent = new Intent(MediaStore.ACTION_IMAGE_CAPTURE);
    captureIntent.putExtra(MediaStore.EXTRA_OUTPUT, outputFileUri);
    startActivityForResult(captureIntent, REQUEST_IMAGE_CAPTURE);
  }

//receive
@Override protected void onActivityResult(int requestCode, int resultCode, Intent data) {
    super.onActivityResult(requestCode, resultCode, data);

    if (resultCode != RESULT_OK) {
      Log.d(TAG, &quot;canceled or other exception!&quot;);
      return;
    }

    if (requestCode == REQUEST_IMAGE_CAPTURE) {
      Log.d(TAG, &quot;REQUEST_IMAGE_CAPTURE&quot;);
      //TODO:Use the Uri 
      Intent intent = new Intent(this, ImageFilterActivity.class);
      intent.setData(outputFileUri);
      startActivity(intent);
    }

  }
</code></pre><p>关于文件如何创建，目前我找到的就是这个最稳定了，写到SD卡根目录（每个手机位置都不一样，坑太多了），再说一遍，data目录（Context.getXXDir()）是私有目录，其它程序（比如Camera）是写不进去的</p>
<pre><code>public class FileUtils {

  public static File createImageFile() {
    // Create an image file name
    String timeStamp = new SimpleDateFormat(&quot;yyyyMMdd_HHmmss&quot;).format(new Date());
    String imageFileName = &quot;JPEG_&quot; + timeStamp + &quot;_&quot;;
    try {
      File image = File.createTempFile(imageFileName,  /* prefix */
          &quot;.jpg&quot;,         /* suffix */
          Environment.getExternalStorageDirectory()      /* directory */);
      return image;
    } catch (IOException e) {
      //do noting
      return null;
    }
  }
}
</code></pre><h2 id="获取Gallery里面的图片"><a href="#获取Gallery里面的图片" class="headerlink" title="获取Gallery里面的图片"></a>获取Gallery里面的图片</h2><p>用途：获取MINETYPE为”image/*”的图片</p>
<p>返回示例 :</p>
<pre><code>content://com.android.providers.media.documents/document/image%3A445
</code></pre><p>使用方法：</p>
<pre><code>public final static int REQUEST_IMAGE_SELECT = 2;

@OnClick(R.id.itemSelectGallery) void itemSwitches() {
    Intent intent = new Intent(Intent.ACTION_PICK);
    intent.setType(&quot;image/*&quot;);
    intent.setAction(Intent.ACTION_GET_CONTENT);
    startActivityForResult(intent, REQUEST_IMAGE_SELECT);
  }

@Override protected void onActivityResult(int requestCode, int resultCode, Intent data) {
super.onActivityResult(requestCode, resultCode, data);

    if (resultCode != RESULT_OK) {
      Log.d(TAG, &quot;canceled or other exception!&quot;);
      return;
    }

    if (requestCode == REQUEST_IMAGE_SELECT) {
      Log.d(TAG, &quot;REQUEST_IMAGE_SELECT&quot;);
      //TODO:Use Uri
      Intent intent = new Intent(this, ImageFilterActivity.class);
      intent.setData(data.getData());
      startActivity(intent);
    }
}
</code></pre><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>这篇文章绝对比stackoverflow上的许多回答都更加完整，我花了很多时间查了很多的方案，最后定下来这三种方法是最好的。  </p>
<blockquote>
<p>摘录来自：<a href="http://www.jianshu.com/p/d4793d32a5fb" target="_blank" rel="external">简书作者</a></p>
</blockquote>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://ocnyang.com/2016/08/12/OrmLiteAbout/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="OCN.Yang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/ocnyang.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="杨欧神/OCN.Yang">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/08/12/OrmLiteAbout/" itemprop="url">
                  ORMLite框架实践详解
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-08-12T18:03:15+08:00">
                2016-08-12
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/第三方框架/" itemprop="url" rel="index">
                    <span itemprop="name">第三方框架</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/08/12/OrmLiteAbout/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/08/12/OrmLiteAbout/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2016/08/12/OrmLiteAbout/" class="leancloud_visitors" data-flag-title="ORMLite框架实践详解">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="ORMLite框架实践详解"><a href="#ORMLite框架实践详解" class="headerlink" title="ORMLite框架实践详解"></a>ORMLite框架实践详解</h1><blockquote>
<p>装载来自：张鸿洋的博客<br><a href="http://blog.csdn.net/lmj623565791/article/details/39121377" target="_blank" rel="external">Android ORMLite 框架的入门用法</a><br><a href="http://blog.csdn.net/lmj623565791/article/details/39122981" target="_blank" rel="external">Android ORMLite 框架最佳实践</a>  </p>
</blockquote>
<p>大家在Android项目中或多或少的都会使用数据库，为了提高我们的开发效率，当然少不了数据库ORM框架了，尤其是某些数据库操作特别频繁的app；本篇博客将通过一个实例来详细介绍ORMLite  </p>
<h2 id="1、下载-ORMLite-Jar"><a href="#1、下载-ORMLite-Jar" class="headerlink" title="1、下载 ORMLite Jar"></a>1、下载 ORMLite Jar</h2><p>首先去<a href="http://ormlite.com/releases/" target="_blank" rel="external">ORMLite官网</a>下载jar包，对于Android为：ormlite-android-5.0.jar 和 ormlite-core-5.0.jar；<br>如果你使用的开发工具是Eclipse的话，有了jar,然后把jar拷贝到libs下，然后右键点击jar包点击add Libary(即添加依赖)。<br>如果你使用的开发工具是Android Studio的话，只需要在build.gradle文件里引入包就行了：  </p>
<pre><code>compile &apos;com.j256.ormlite:ormlite-android:5.0&apos;
compile &apos;com.j256.ormlite:ormlite-core:5.0&apos;
</code></pre><blockquote>
<p>访问不了的朋友，这里会把jar、源码、doc与本篇博客例子一起打包提供给大家<a href="http://obbu6r1mi.bkt.clouddn.com/zhy_ormlite.rar" target="_blank" rel="external">下载</a>。</p>
</blockquote>
<h2 id="2、配置Bean类"><a href="#2、配置Bean类" class="headerlink" title="2、配置Bean类"></a>2、配置Bean类</h2><p>我们直接新建一个项目为：zhy_ormlite。<br>然后新建一个包：com.zhy.zhy_ormlite.bean专门用于存放项目中的Bean，首先新建一个User.java</p>
<pre><code>package com.zhy.zhy_ormlite.bean;

import java.util.Collection;

import com.j256.ormlite.field.DatabaseField;
import com.j256.ormlite.field.ForeignCollectionField;
import com.j256.ormlite.table.DatabaseTable;

@DatabaseTable(tableName = &quot;tb_user&quot;)
public class User 
{
    @DatabaseField(generatedId = true)
    private int id;
    @DatabaseField(columnName = &quot;name&quot;)
    private String name;

    @ForeignCollectionField
    private Collection&lt;Article&gt; articles;

    public Collection&lt;Article&gt; getArticles()
    {
        return articles;
    }

    public void setArticles(Collection&lt;Article&gt; articles)
    {
        this.articles = articles;
    }

    public User()
    {
    }

    public int getId()
    {
        return id;
    }

    public void setId(int id)
    {
        this.id = id;
    }

    public String getName()
    {
        return name;
    }

    public void setName(String name)
    {
        this.name = name;
    }

    @Override
    public String toString()
    {
        return &quot;User [id=&quot; + id + &quot;, name=&quot; + name + &quot;, articles=&quot; + articles
                + &quot;]&quot;;
    }

}
</code></pre><ul>
<li>首先在User类上添加@DatabaseTable(tableName = “tb_user”)，标明这是数据库中的一张表，标明为tb_user</li>
<li>然后分别在属性上添加@DatabaseField(columnName = “name”) ，columnName的值为该字段在数据中的列名</li>
<li>@DatabaseField(generatedId = true) ，generatedId 表示id为主键且自动生成</li>
</ul>
<h2 id="3、ORMLite外键引用"><a href="#3、ORMLite外键引用" class="headerlink" title="3、ORMLite外键引用"></a>3、ORMLite外键引用</h2><p>现在我们有两张表一张User，一张Article；<br>Article中当然需要存储User的主键，作为关联~~那么在ORMLite中如何做到呢？<br>可能有人会直接在Article中声明一个int类型userId属性，当作普通属性处理搞定，这种做法并没有做，但是没有体现出面向对象的思想。<br>面向对象是这样的：Article属于某个User<br>类这么定义：</p>
<pre><code>1. package com.zhy.zhy_ormlite.bean;  
2.   
3. import com.j256.ormlite.field.DatabaseField;  
4. import com.j256.ormlite.table.DatabaseTable;  
5.   
6. @DatabaseTable(tableName = &quot;tb_article&quot;)  
7. public class Article  
8. {  
9.     @DatabaseField(generatedId = true)  
10.     private int id;  
11.     @DatabaseField  
12.     private String title;  
13.     @DatabaseField(canBeNull = true, foreign = true, columnName = &quot;user_id&quot;)  
14.     private User user;  
15.   
16.     public int getId()  
17.     {  
18.         return id;  
19.     }  
20.   
21.     public void setId(int id)  
22.     {  
23.         this.id = id;  
24.     }  
25.   
26.     public String getTitle()  
27.     {  
28.         return title;  
29.     }  
30.   
31.     public void setTitle(String title)  
32.     {  
33.         this.title = title;  
34.     }  
35.   
36.     public User getUser()  
37.     {  
38.         return user;  
39.     }  
40.   
41.     public void setUser(User user)  
42.     {  
43.         this.user = user;  
44.     }  
45.   
46.     @Override  
47.     public String toString()  
48.     {  
49.         return &quot;Article [id=&quot; + id + &quot;, title=&quot; + title + &quot;, user=&quot; + user  
50.                 + &quot;]&quot;;  
51.     }  
52.   
53. }  
</code></pre><p>不会去定义一个int类型的userId，而是直接定义一个User成员变量，表示本Article属于该User;<br>然后在User user属性上添加：</p>
<pre><code>@DatabaseField(canBeNull = true, foreign = true, columnName = &quot;user_id&quot;)
</code></pre><blockquote>
<ul>
<li>canBeNull表示不能为null；</li>
<li>foreign=true表示是一个外键;</li>
<li>columnName 列名</li>
</ul>
</blockquote>
<h2 id="4、编写DAO类"><a href="#4、编写DAO类" class="headerlink" title="4、编写DAO类"></a>4、编写DAO类</h2><p>我们可能会有很多表嘛，每个表一般我们都会单独写个Dao用于操作</p>
<pre><code>public class UserDao
{
    private Context context;
    private Dao&lt;User, Integer&gt; userDaoOpe;
    private DatabaseHelper helper;

    public UserDao(Context context)
    {
        this.context = context;
        try
        {
            helper = DatabaseHelper.getHelper(context);
            userDaoOpe = helper.getDao(User.class);
        } catch (SQLException e)
        {
            e.printStackTrace();
        }
    }

    /**
     * 增加一个用户
     * 
     * @param user
     * @throws SQLException
     */
    public void add(User user) 
    {
        /*//事务操作
        TransactionManager.callInTransaction(helper.getConnectionSource(),
                new Callable&lt;Void&gt;()
                {

                    @Override
                    public Void call() throws Exception
                    {
                        return null;
                    }
                });*/
        try
        {
            userDaoOpe.create(user);
        } catch (SQLException e)
        {
            e.printStackTrace();
        }

    }

    public User get(int id)
    {
        try
        {
            return userDaoOpe.queryForId(id);
        } catch (SQLException e)
        {
            e.printStackTrace();
        }
        return null;
    }

}
</code></pre><p>我们的所有的XXXDao遵循以上的风格~</p>
<pre><code>public class ArticleDao {
    private Dao&lt;Article, Integer&gt; articleDaoOpe;
    private DatabaseHelper helper;

    @SuppressWarnings(&quot;unchecked&quot;)
    public ArticleDao(Context context) {
        try {
            helper = DatabaseHelper.getHelper(context);
            articleDaoOpe = helper.getDao(Article.class);
        } catch (SQLException e) {
            e.printStackTrace();
        }
    }

    /**
     * 添加一个Article
     *
     * @param article
     */
    public void add(Article article) {
        try {
            articleDaoOpe.create(article);
        } catch (SQLException e) {
            e.printStackTrace();
        }
    }

    /**
     * 通过Id得到一个Article
     *
     * @param id
     * @return
     */
    @SuppressWarnings(&quot;unchecked&quot;)
    public Article getArticleWithUser(int id) {
        Article article = null;
        try {
            article = articleDaoOpe.queryForId(id);
            helper.getDao(User.class).refresh(article.getUser());

        } catch (SQLException e) {
            e.printStackTrace();
        }
        return article;
    }

    /**
     * 通过Id得到一篇文章
     *
     * @param id
     * @return
     */
    public Article get(int id) {
        Article article = null;
        try {
            article = articleDaoOpe.queryForId(id);

        } catch (SQLException e) {
            e.printStackTrace();
        }
        return article;
    }

    /**
     * 通过UserId获取所有的文章
     *
     * @param userId
     * @return
     */
    public List&lt;Article&gt; listByUserId(int userId) {
        try {
            return articleDaoOpe.queryBuilder().where().eq(&quot;user_id&quot;, userId)
                    .query();
        } catch (SQLException e) {
            e.printStackTrace();
        }
        return null;
    }
</code></pre><hr>
<h2 id="4、DatabaseHelper"><a href="#4、DatabaseHelper" class="headerlink" title="4、DatabaseHelper"></a>4、DatabaseHelper</h2><p>我们使用ORMLite，需要自己写一个DatabaseHelper去继承OrmLiteSqliteOpenHelper，下面我们首先给出一个我认为比较靠谱的Helper的写法：</p>
<pre><code>1. package com.zhy.zhy_ormlite.db;  
2.   
3. import java.sql.SQLException;  
4. import java.util.HashMap;  
5. import java.util.Map;  
6.   
7. import android.content.Context;  
8. import android.database.sqlite.SQLiteDatabase;  
9.   
10. import com.j256.ormlite.android.apptools.OrmLiteSqliteOpenHelper;  
11. import com.j256.ormlite.dao.Dao;  
12. import com.j256.ormlite.support.ConnectionSource;  
13. import com.j256.ormlite.table.TableUtils;  
14. import com.zhy.zhy_ormlite.bean.Article;  
15. import com.zhy.zhy_ormlite.bean.Student;  
16. import com.zhy.zhy_ormlite.bean.User;  
17.   
18. public  class DatabaseHelper extends OrmLiteSqliteOpenHelper  
19. {  
20.     private static final String TABLE_NAME = &quot;sqlite-test.db&quot;;  
21.   
22.     private Map&lt;String, Dao&gt; daos = new HashMap&lt;String, Dao&gt;();  
23.   
24.     private DatabaseHelper(Context context)  
25.     {  
26.         super(context, TABLE_NAME, null, 4);  
27.     }  
28.   
29.     @Override  
30.     public void onCreate(SQLiteDatabase database,  
31.             ConnectionSource connectionSource)  
32.     {  
33.         try  
34.         {  
35.             TableUtils.createTable(connectionSource, User.class);  
36.             TableUtils.createTable(connectionSource, Article.class);  
37.             TableUtils.createTable(connectionSource, Student.class);  
38.         } catch (SQLException e)  
39.         {  
40.             e.printStackTrace();  
41.         }  
42.     }  
43.   
44.     @Override  
45.     public void onUpgrade(SQLiteDatabase database,  
46.             ConnectionSource connectionSource, int oldVersion, int newVersion)  
47.     {  
48.         try  
49.         {  
50.             TableUtils.dropTable(connectionSource, User.class, true);  
51.             TableUtils.dropTable(connectionSource, Article.class, true);  
52.             TableUtils.dropTable(connectionSource, Student.class, true);  
53.             onCreate(database, connectionSource);  
54.         } catch (SQLException e)  
55.         {  
56.             e.printStackTrace();  
57.         }  
58.     }  
59.   
60.     private static DatabaseHelper instance;  
61.   
62.     /** 
63.      * 单例获取该Helper 
64.      *  
65.      * @param context 
66.      * @return 
67.      */  
68.     public static synchronized DatabaseHelper getHelper(Context context)  
69.     {  
70.         context = context.getApplicationContext();  
71.         if (instance == null)  
72.         {  
73.             synchronized (DatabaseHelper.class)  
74.             {  
75.                 if (instance == null)  
76.                     instance = new DatabaseHelper(context);  
77.             }  
78.         }  
79.   
80.         return instance;  
81.     }  
82.   
83.     public synchronized Dao getDao(Class clazz) throws SQLException  
84.     {  
85.         Dao dao = null;  
86.         String className = clazz.getSimpleName();  
87.   
88.         if (daos.containsKey(className))  
89.         {  
90.             dao = daos.get(className);  
91.         }  
92.         if (dao == null)  
93.         {  
94.             dao = super.getDao(clazz);  
95.             daos.put(className, dao);  
96.         }  
97.         return dao;  
98.     }  
99.   
100.     /** 
101.      * 释放资源 
102.      */  
103.     @Override  
104.     public void close()  
105.     {  
106.         super.close();  
107.   
108.         for (String key : daos.keySet())  
109.         {  
110.             Dao dao = daos.get(key);  
111.             dao = null;  
112.         }  
113.     }  
114.   
115. }  
</code></pre><ol>
<li>整个DatabaseHelper使用单例只对外公布出一个对象，保证app中只存在一个SQLite Connection。 <a href="http://www.touchlab.co/2011/10/single-sqlite-connection/" target="_blank" rel="external">参考文章</a>  </li>
<li>我们对每个Bean创建一个XXXDao来处理当前Bean的数据库操作，当然真正去和数据库打交道的对象，通过上面代码中的getDao（T t）进行获取<br>getDao为一个泛型方法，会根据传入Class对象进行创建Dao，并且使用一个Map来保持所有的Dao对象，只有第一次调用时才会去调用底层的getDao()。</li>
</ol>
<h2 id="5、我们的测试类："><a href="#5、我们的测试类：" class="headerlink" title="5、我们的测试类："></a>5、我们的测试类：</h2><pre><code>1. public class OrmLiteDbTest extends AndroidTestCase  
2. {  
3.     public void testAddArticle()  
4.     {  
5.         User u = new User();  
6.         u.setName(&quot;张鸿洋&quot;);  
7.         new UserDao(getContext()).add(u);  
8.         Article article = new Article();  
9.         article.setTitle(&quot;ORMLite的使用&quot;);  
10.         article.setUser(u);  
11.         new ArticleDao(getContext()).add(article);  
12.   
13.     }  
14.   
15.     public void testGetArticleById()  
16.     {  
17.         Article article = new ArticleDao(getContext()).get(1);  
18.         L.e(article.getUser() + &quot; , &quot; + article.getTitle());  
19.     }  
20.   
21.     public void testGetArticleWithUser()  
22.     {  
23.   
24.         Article article = new ArticleDao(getContext()).getArticleWithUser(1);  
25.         L.e(article.getUser() + &quot; , &quot; + article.getTitle());  
26.     }  
27.       
28.     public void testListArticlesByUserId()  
29.     {  
30.   
31.         List&lt;Article&gt; articles = new ArticleDao(getContext()).listByUserId(1);  
32.         L.e(articles.toString());  
33.     }  
</code></pre><p>分别测试，添加一个Article；通过Id获取一个Article；通过Id获取一个Article且携带User；通过userId获取所有的Article；<br>主要看第三个：通过Id获取一个Article且携带User，testGetArticleWithUser（id）<br>如何值传一个Article的Id，然后能够拿到Article对象，且内部的user属性直接赋值呢？<br>两种方式： </p>
<ul>
<li><p>1、即上述写法</p>
<pre><code>1. article = articleDaoOpe.queryForId(id);  
2.  helper.getDao(User.class).refresh(article.getUser());  
</code></pre></li>
<li><p>2、在user属性的注解上：</p>
<pre><code>@DatabaseField(canBeNull = true, foreign = true, columnName = &quot;user_id&quot;, foreignAutoRefresh = true)
</code></pre></li>
</ul>
<p>添加foreignAutoRefresh =true，这样；当调用queryForId时，拿到Article对象则直接携带了user；</p>
<h2 id="6、关联一个集合"><a href="#6、关联一个集合" class="headerlink" title="6、关联一个集合"></a>6、关联一个集合</h2><p>每个User关联一个或多个Article，如果我在User中声明一个Collection<article> articles，我能否在查询User的时候，一并能够获取到articles的值呢？<br>答案是可以的。在User中添加如下属性，且注解如下：<br>@ForeignCollectionField<br>private Collection<article> articles;<br>我们在UserDao中书写查询User的代码：</article></article></p>
<pre><code>1. public User get(int id)  
2.     {  
3.         try  
4.         {  
5.             return userDaoOpe.queryForId(id);  
6.         } catch (SQLException e)  
7.         {  
8.             e.printStackTrace();  
9.         }  
10.         return null ;  
11.     }  
</code></pre><p>测试代码：</p>
<pre><code>1. public void testGetUserById()  
2.     {  
3.         User user = new UserDao(getContext()).get(1);  
4.         L.e(user.getName());  
5.         if (user.getArticles() != null)  
6.             for (Article article : user.getArticles())  
7.             {  
8.                 L.e(article.toString());  
9.             }  
10.     }  
</code></pre><p>输出：</p>
<pre><code>1. 09-07 22:49:06.484: E/zhy(7293): 欧神  
2. 09-07 22:49:06.484: E/zhy(7293): Article [id=1, title=ORMLite的使用]  
</code></pre><p>可以看到，我们通过一个queryForId，成功的获取了User，以及User关联的所有的Articles；</p>
<h2 id="7、条件查询QueryBuilder的使用"><a href="#7、条件查询QueryBuilder的使用" class="headerlink" title="7、条件查询QueryBuilder的使用"></a>7、条件查询QueryBuilder的使用</h2><p>上述代码其实已经用到了简单的条件查询了：</p>
<ul>
<li>简单的where等于<br>articleDaoOpe.queryBuilder().where().eq(“user_id”, userId).query();直接返回Article的列表</li>
<li><p>where and </p>
<pre><code>1. QueryBuilder&lt;Article, Integer&gt; queryBuilder = articleDaoOpe  
2.                 .queryBuilder();  
3.         Where&lt;Article, Integer&gt; where = queryBuilder.where();  
4.         where.eq(&quot;user_id&quot;, 1);  
5.         where.and();  
6.         where.eq(&quot;name&quot;, &quot;xxx&quot;);  
7.   
8.         //或者  
9.         articleDaoOpe.queryBuilder().//  
10.                 where().//  
11.                 eq(&quot;user_id&quot;, 1).and().//  
12.                 eq(&quot;name&quot;, &quot;xxx&quot;);  
</code></pre></li>
</ul>
<p>上述两种都相当与：select * from tb_article where user_id = 1 and name = ‘xxx’ ;</p>
<ul>
<li><p>更复杂的查询</p>
<pre><code>1. where.or(  
2.                     //  
3.                     where.and(//  
4.                             where.eq(&quot;user_id&quot;, 1), where.eq(&quot;name&quot;, &quot;xxx&quot;)),  
5.                     where.and(//  
6.                             where.eq(&quot;user_id&quot;, 2), where.eq(&quot;name&quot;, &quot;yyy&quot;)));  
</code></pre></li>
</ul>
<p>select * from tb_article where ( user_id = 1 and name = ‘xxx’ )  or ( user_id = 2 and name = ‘yyy’ )  ;<br>好了，再复杂的查询估计也能够凑出来了~~</p>
<h2 id="8、updateBuilder、deleteBuilder"><a href="#8、updateBuilder、deleteBuilder" class="headerlink" title="8、updateBuilder、deleteBuilder"></a>8、updateBuilder、deleteBuilder</h2><p>使用queryBuilder是因为我们希望执行完成查询直接返回List<bean>集合；<br>对于Update我们并不关注返回值，直接使用<br>articleDaoOpe.updateRaw(statement, arguments);传入sql和参数即可~~<br>何必在那<br>articleDaoOpe.updateBuilder().updateColumnValue(“name”,”zzz”).where().eq(“user_id”, 1);这样的痛苦呢~~~<br>同理还有deleteBuilder还是建议直接拼写sql，当然很简单的除外，直接使用它的API~</bean></p>
<h2 id="9、事务操作"><a href="#9、事务操作" class="headerlink" title="9、事务操作"></a>9、事务操作</h2><p>在我们的Dao中直接写如下代码：</p>
<pre><code>1. //事务操作  
2.         TransactionManager.callInTransaction(helper.getConnectionSource(),  
3.                 new Callable&lt;Void&gt;()  
4.                 {  
5.   
6.                     @Override  
7.                     public Void call() throws Exception  
8.                     {  
9.                         return null;  
10.                     }  
11.                 });  
</code></pre><h2 id="10、其他操作"><a href="#10、其他操作" class="headerlink" title="10、其他操作"></a>10、其他操作</h2><ul>
<li><p>1、当Bean继承BaseDaoEnabled时，可以使用bean.create(bean)；bean.update(bean)一类操作<br>例如：  </p>
<pre><code>Student extends BaseDaoEnabled&lt;Student, Integer&gt;
Dao dao = DatabaseHelper.getHelper(getContext()).getDao(Student.class);
Student student = new Student();
student.setDao(dao);
student.setName(&quot;张鸿洋&quot;);
student.create();
</code></pre></li>
</ul>
<p>前提dao需要手动设置，如果dao为null会报错，尼玛，我觉得一点用没有。。。</p>
<ul>
<li><p>2、Join</p>
<pre><code>1. QueryBuilder&lt;Article, Integer&gt; articleBuilder = articleDaoOpe  
2.                     .queryBuilder();  
3.             QueryBuilder userBuilder = helper.getDao(User.class).queryBuilder();  
4.             articleBuilder.join(userBuilder);  
</code></pre></li>
</ul>
<p>Article与User做Join操作；</p>
<p>本篇主要想介绍在项目中如何写DataBaseHelper已经如何写BeanDao，以及列出了在项目中可能会用到的ORMLite的功能，如果需要详细了解，还请看ORMLite官方文档，源码中也会提供~~</p>
<blockquote>
<p><a href="http://obbu6r1mi.bkt.clouddn.com/zhy_ormlite.rar" target="_blank" rel="external">源码点击下载</a></p>
</blockquote>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://ocnyang.com/2016/08/10/CustomView/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="OCN.Yang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/ocnyang.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="杨欧神/OCN.Yang">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/08/10/CustomView/" itemprop="url">
                  自定义view详解
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-08-10T13:03:15+08:00">
                2016-08-10
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android教程系列/" itemprop="url" rel="index">
                    <span itemprop="name">Android教程系列</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/08/10/CustomView/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/08/10/CustomView/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2016/08/10/CustomView/" class="leancloud_visitors" data-flag-title="自定义view详解">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Android-自定义-view-详解"><a href="#Android-自定义-view-详解" class="headerlink" title="Android 自定义 view 详解"></a>Android 自定义 view 详解</h1><blockquote>
<p>摘录来源：<a href="http://android.jobbole.com/83835/" target="_blank" rel="external">伯乐在线专栏作者 - 邵辉|CRR</a>  </p>
</blockquote>
<p>对于我这样一个Android初级开发者来说，自定义View一直是一个遥不可及的东西，每次看到别人做的特别漂亮的控件，自己心里那个痒痒啊，可是又生性懒惰，自己不肯努力去看书，只能望而兴叹，每次做需求用到自定义控件，就直接去Github上找，找到合适的就用，找不到合适的，凑合也用，反正从来没想过要自己来做这样的东西，可是毕业以后到了新公司，为了自己的荣誉，这次不得不硬着头皮自己来了，一个月的紧张开发过后，回头再看，自定义控件也无非那么回事，只要记得几个要领，几乎是手到擒来。</p>
<h3 id="从继承开始"><a href="#从继承开始" class="headerlink" title="从继承开始"></a>从继承开始</h3><p>懂点面向对象语言知识的都知道：封装，继承和多态，这是面向对象的三个基本特征，所以在自定义View的时候，最简单的方法就是继承现有的View   </p>
<pre><code>public class SketchView extends View{  
    public SketchView(Context context) {
        super(context);
    }
    public SketchView(Context context, AttributeSet attrs) {
        super(context, attrs);
    }



    public SketchView(Context context, AttributeSet attrs, int defStyleAttr) {
        super(context, attrs, defStyleAttr);
    }
}
</code></pre><p>通过上面这段代码，我定义了一个SketchView，继承自View对象，并且复写了它的三个构造方法，我主要来分析一下这三个构造方法：  </p>
<ul>
<li><p>第一个构造方法就是我们普通在代码中新建一个view用到的方法，例如  </p>
<pre><code>SketchView sketchView = new SketchView(this);
</code></pre></li>
</ul>
<p>就这样，一个自定义的view就被新建出来了，然后可以根据需求添加到布局里</p>
<ul>
<li><p>第二个构造方法就是我们一般在xml文件里添加一个view  </p>
<pre><code>&lt;me.shaohui.androidpractise.widget.SketchView

   android:layout_width=&quot;match_parent&quot;

   android:layout_height=&quot;match_parent&quot;

   android:layout_marginRight=&quot;16dp&quot;

   android:layout_marginTop=&quot;16dp&quot; /&gt;
</code></pre></li>
</ul>
<ul>
<li>这样，我们就把一个SketchView添加到布局文件里，并且加了一些布局属性，宽高属性以及margin属性，这些属性会存放在第二个构造函数的AttributeSet参数里</li>
</ul>
<ul>
<li>第三个构造函数比第二个构造函数多了一个int型的值，名字叫defStyleAttr，从名称上判断，这是一个关于自定义属性的参数，实际上我们的猜测也是正确的，第三个构造函数不会被系统默认调用，而是需要我们自己去显式调用，比如在第二个构造函数里调用调用第三个函数，并将第三个参数设为0。</li>
</ul>
<blockquote>
<p>关于第三个参数defStyleAttr,其实也可以拿出来说一整篇文章，有想详细了解的读者可以去看下本篇文章最后的第三个参考链接，我在这里只是简单的说一下：defStyleAttr指定的是在Theme style定义的一个attr，它的类型是reference,主要生效在obtainStyledAttributes方法里，obtainStyledAttributes方法有四个参数，第三个参数是defStyleAttr，第四个参数是自己指定的一个style，当且仅当defStyleAttr为0或者在Theme中找不到defStyleAttr指定的属性时，第四个参数才会生效，这些指的都是默认属性，当在xml里面定义的，就以在xml文件里指定的为准，所以优先级大概是：xml&gt;style&gt;defStyleAttr&gt;defStyleRes&gt;Theme指定，当defStyleAttr为0时，就跳过defStyleAttr指定的reference，所以一般用0就能满足一些基本开发。</p>
</blockquote>
<h3 id="Measure-gt-Layout-gt-Draw"><a href="#Measure-gt-Layout-gt-Draw" class="headerlink" title="Measure-&gt;Layout-&gt;Draw"></a>Measure-&gt;Layout-&gt;Draw</h3><p>在学会如何写一个自定义控件之前，了解一个控件的绘制流程是必要的，在Android里，一个view的绘制流程包括：Measure，Layout和Draw，通过onMeasure知道一个view要占界面的大小，然后通过onLayout知道这个控件应该放在哪个位置，最后通过onDraw方法将这个控件绘制出来，然后才能展现在用户面前，下面我将挨个分析一下这三个方法的作用。</p>
<ul>
<li>onMeasure 测量，通过测量知道一个一个view要占的大小，方法参数是两个int型的值，我们都知道，在java中，int型由4个字节（32bit）组成，在MeasureSpce中，用前两位表示mode，用后30位表示size</li>
</ul>
<pre><code>@Override  
protected void onMeasure(int widthMeasureSpec, int heightMeasureSpec) {

int widthMode = MeasureSpec.getMode(widthMeasureSpec);
int widthSize = MeasureSpec.getSize(widthMeasureSpec);
int heightMode = MeasureSpec.getMode(heightMeasureSpec);
int heightSize = MeasureSpec.getSize(heightMeasureSpec);
int measuredHeight, measuredWidth;
if (widthMode == MeasureSpec.EXACTLY) {
    measuredWidth = widthSize;
} else {
    measuredWidth = SIZE;
}
if (heightMode == MeasureSpec.EXACTLY) {

    measuredHeight = heightSize;

} else {

    measuredHeight = SIZE;

}
setMeasuredDimension(measuredWidth, measuredHeight);

}
</code></pre><p>MeasureSpce的mode有三种：EXACTLY, AT_MOST，UNSPECIFIED，除却UNSPECIFIED不谈，其他两种mode：当父布局是EXACTLY时，子控件确定大小或者match_parent，mode都是EXACTLY，子控件是wrap_content时，mode为AT_MOST；当父布局是AT_MOST时，子控件确定大小，mode为EXACTLY，子控件wrap_content或者match_parent时，mode为AT_MOST。所以在确定控件大小时，需要判断MeasureSpec的mode，不能直接用MeasureSpec的size。在进行一些逻辑处理以后，调用setMeasureDimension()方法，将测量得到的宽高传进去供layout使用。  </p>
<p><img src="http://obbu6r1mi.bkt.clouddn.com/myview1.png" alt="">  </p>
<blockquote>
<p>需要明白的一点是 ,测量所得的宽高不一定是最后展示的宽高，最后宽高确定是在onLayout方法里，layou（left，top，right，bottom），不过一般都是一样的。</p>
</blockquote>
<ul>
<li>onLayout 实际上，我在自定义SketchView的时候是没有重写onLayout方法的，因为SketchView只是一个单纯的view，它不是一个view容器，没有子view，而onLayout方法里主要是具体摆放子view的位置，水平摆放或者垂直摆放，所以在单纯的自定义view是不需要重写onLayout方法，不过需要注意的一点是，子view的margin属性是否生效就要看parent是否在自身的onLayout方法进行处理，而view得padding属性是在onDraw方法中生效的。</li>
</ul>
<p>其实在onLayout方法里有一个属性我一直关注并且没有弄得很明白，就是第一个参数boolean:changed，标示这个view的大小是否发生改变，后续了解到，会回来补坑。</p>
<ul>
<li>onDraw 终于说到了重头戏，一般自定义控件耗费心思最多的就是这个方法了，需要在这个方法里，用Paint在Canvas上画出你想要的图案，这样一个自定义view才算结束。下面会详细讲如何在画布上画出自己想要的图案。</li>
</ul>
<blockquote>
<p>关于onDraw方法，在补充一句，如果是直接继承的View，那么在重写onDraw的方法是时候完全可以把super.ondraw(canvas)删掉，因为它的默认实现是空。</p>
</blockquote>
<h3 id="得到一个正方形的View"><a href="#得到一个正方形的View" class="headerlink" title="得到一个正方形的View"></a>得到一个正方形的View</h3><p>上一部分主要说了一下，view的绘制流程，从这三个方法中，我们可以知道如何测量一个控件，如何摆放控件的子元素，如何绘制图案，下面我说一下自己通过onMeasure学到的一点小技巧。</p>
<p>在日常开发中，我们偶尔会需要一个正方形的imageView，一般都是通过指定宽高，但是当宽高不确定时，我们就只能寄希望于Android原声支持定义view的比例，但是现实是残酷的，系统好像是没有提供类似属性的，所以我们就只能自己去实现，其实自己写起来也特别的简单，只需要改一个参数就OK了，  </p>
<pre><code>@Override
protected void onMeasure(int widthMeasureSpec, int heightMeasureSpec) {
    super.onMeasure(widthMeasureSpec, widthMeasureSpec);
   }
</code></pre><p>不仔细观察是看不出来其中的奥妙的，虽然这里复写了view的onMeasure，但是貌似没有做任何处理，直接调用了super方法，但是仔细观察的话就会发现，在调用super方法的时候，第二个参数变了，本来应该是heightMeasureSpec却换成了widthMeasureSpec，这样view的高度就是view的宽度，一个SquareView就实现了，甚至如果通过自定义属性实现一个自定义比例view。</p>
<h3 id="自定义属性"><a href="#自定义属性" class="headerlink" title="自定义属性"></a>自定义属性</h3><p>自定义view没有自定义属性怎么得了，要给view支持自定义属性，需要在values/attrs.xml 文件里定义一个name为自己定义view名字的declare-styleable</p>
<pre><code>&lt;resources&gt;

    &lt;declare-styleable name=&quot;SketchView&quot;&gt;
        &lt;attr name=&quot;background_color&quot; format=&quot;color&quot;/&gt;
        &lt;attr name=&quot;size&quot; format=&quot;dimension&quot;/&gt;
    &lt;/declare-styleable&gt;

&lt;/resources&gt;
</code></pre><p>这样就可以在xml文件里使用自己定义的属性了</p>
<pre><code>&lt;me.shaohui.androidpractise.widget.SketchView
       xmlns:app=&quot;http://schemas.android.com/apk/res-auto&quot;
       android:layout_width=&quot;match_parent&quot;
       android:layout_height=&quot;match_parent&quot;
       android:layout_marginRight=&quot;16dp&quot;
       android:layout_marginTop=&quot;16dp&quot;
       app:background_color=&quot;@color/colorPrimary&quot;
       app:size=&quot;24dp&quot;/&gt;
</code></pre><p>别忘了在前面加上自定义的命名空间，到这来看，增加自定义属性并不算什么，不过要自定义属性生效还是要耗费一些功夫的，这时候前面留下的伏笔：第三个构造方法的defStyleAttr参数就要登场了。</p>
<pre><code>public SketchView(Context context, AttributeSet attrs, int defStyleAttr) {
        super(context, attrs, defStyleAttr);

        TypedArray a = context.obtainStyledAttributes(attrs, R.styleable.SketchView, defStyleAttr, R.style.AppTheme);

        custom_size = a.getDimensionPixelSize(R.styleable.SketchView_size, SIZE);
        custon_background = a.getColor(R.styleable.SketchView_background_color, DEFAULT_COLOR);

        a.recycle();
    }
</code></pre><p>经过好一番操作，才能把xml定义的属性拿出来，具体取得的值为多少，我在前面已经解释过，就不在这里多说，接下来的操作就是拿着这些属性干你想干的事吧。</p>
<h3 id="实战：一个动态view"><a href="#实战：一个动态view" class="headerlink" title="实战：一个动态view"></a>实战：一个动态view</h3><p>下面将简单介绍一下如何在onDraw(Canvas canvas) 在画布的中心位置画一个自定义颜色的圆，并且通过一个ValueAnimator让这个圆动起来，废话不多说，直接上代码：</p>
<pre><code>@Override
protected void onDraw(Canvas canvas) {
    canvas.drawCircle(mWidth/2, mHeight/2, custom_size * scale, mPaint);
}

private ValueAnimator mAnimator;
public void startAnimation() {
    mAnimator = ValueAnimator.ofFloat(1, 2);

    mAnimator.addUpdateListener(new ValueAnimator.AnimatorUpdateListener() {

        @Override
        public void onAnimationUpdate(ValueAnimator animation) {
            scale = (float) animation.getAnimatedValue();
            postInvalidate();

        }

    });

    // 重复次数 -1表示无限循环
    mAnimator.setRepeatCount(-1);

    // 重复模式, RESTART: 重新开始 REVERSE:恢复初始状态再开始

    mAnimator.setRepeatMode(ValueAnimator.REVERSE);
    mAnimator.start();

}
</code></pre><p>(只贴了核心代码，完整代码会在文章最后给链接)</p>
<p>可以看到在onDraw()方法里，我调用了canvas的drawCircle方法画了一个圆，圆心的位置是又画布的位置决定的，位于画布的中心，width和height参数是在onLayout()方法里拿到的，在此之前取到的height和width都是不准确的，这点要注意。圆的半径是xml文件中定义的size*scale，而这个scale是通过一个ValueAnimator确定的，变化范围是从1到2，ValueAnimator的值发生改变会赋给scale同时调用postInvalidate()方法，这个方法的作用就是重绘，然后圆的半径就会发生改变，这样刷新就会实现动画的效果。  </p>
<p><img src="http://obbu6r1mi.bkt.clouddn.com/myview2.gif" alt="">  </p>
<h3 id="requstLayout和invidious"><a href="#requstLayout和invidious" class="headerlink" title="requstLayout和invidious"></a>requstLayout和invidious</h3><p>在自定义view时，时常用到刷新view的方法，这时候就会有三个方法供我们选择：requestLayout()、invalidate()、postInvalidate()，其实invalidate和postInvalidate这两个方法作用是一样的，唯一不同的是invalidate用在主线程，而postInvalidate用在异步线程，下面对比一下requestLayout和invalidate的内部实现：</p>
<pre><code>@Override
public void requestLayout() {
    if (!mHandlingLayoutInLayoutRequest) {
        checkThread();
        mLayoutRequested = true;
        scheduleTraversals();
    }
}

void invalidate() {
    mDirty.set(0, 0, mWidth, mHeight);
    if (!mWillDrawSoon) {
        scheduleTraversals();
    }
}
</code></pre><p>从代码可以看出，其实这两个方法内部都是调用的scheduleTraversals()方法，不同的是，requestLayout方法将mLayoutRequested标示置为true，scheduleTraversals这个方法以后找机会再细分析，现在只简单说下结论，</p>
<ul>
<li>requestLayout会调用measure和layout 等一系列操作，然后根据布局是否发生改变，surface是否被销毁，来决定是否调用draw，也就是说requestlayout肯定会调用measure和layout，但不一定调用draw，读者可以试着改下我上面写的那个小程序，将postInvalidate改成requestlayout，动画效果就消失了，因为布局没有发生改变。</li>
</ul>
<ul>
<li>invalidate 只会调用draw，而且肯定会调，即使什么都没有发生改变，它也会重新绘制。</li>
</ul>
<p>所以如果有布局需要发生改变，需要调用requestlayout方法，如果只是刷新动画，则只需要调用invalidate方法。</p>
<h3 id="自定义view的状态保存"><a href="#自定义view的状态保存" class="headerlink" title="自定义view的状态保存"></a>自定义view的状态保存</h3><p>自定义view的状态保存和Activity的状态保存是类似的，都是在onSaveInstanceState()保存，然后在onRestoreInstanceState将数据安全取出，之所以在这是还是多说一嘴，主要是怕自己忘，给自己提个醒，也顺便给各位看客叨扰几句，还有一个就是，如果一个view没有id，这个view的状态是不会保存的。</p>
<h3 id="事件处理onTouchEvent"><a href="#事件处理onTouchEvent" class="headerlink" title="事件处理onTouchEvent"></a>事件处理onTouchEvent</h3><p>Android的事件处理太过复杂，我会在以后另起一篇文章来好好聊一下Android里的事件处理。</p>
<h3 id="In-The-End"><a href="#In-The-End" class="headerlink" title="In The End"></a>In The End</h3><p>自定义view其实是一个很重的知识点，里面包含了很多view的知识，不是一篇文章就能聊完的，但我又不习惯连载，有什么话总喜欢一口气说完，所以都写在这一篇文章里了，我这里只是简单的和大家开个头，具体深知里面的细节还是要看很多东西。文章里有什么不对的地方，望各位指出。</p>
<p>源码地址：<a href="https://github.com/shaohui10086/AndroidPractise/blob/master/app/src/main/java/me/shaohui/androidpractise/widget/SketchView.java" target="_blank" rel="external">Github地址</a></p>
<p>##参考链接</p>
<blockquote>
<ul>
<li><a href="http://ghui.me/post/2015/10/view-measure/" target="_blank" rel="external">http://ghui.me/post/2015/10/view-measure/</a></li>
<li><a href="http://blog.csdn.net/wzy_1988/article/details/49619773" target="_blank" rel="external">http://blog.csdn.net/wzy_1988/article/details/49619773</a></li>
<li><a href="http://www.cnblogs.com/angeldevil/p/3479431.html" target="_blank" rel="external">http://www.cnblogs.com/angeldevil/p/3479431.html</a></li>
</ul>
</blockquote>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://ocnyang.com/2016/08/09/GlideAbout/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="OCN.Yang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/ocnyang.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="杨欧神/OCN.Yang">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/08/09/GlideAbout/" itemprop="url">
                  图片加载库Glide介绍
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-08-09T18:03:15+08:00">
                2016-08-09
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/第三方框架/" itemprop="url" rel="index">
                    <span itemprop="name">第三方框架</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/08/09/GlideAbout/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/08/09/GlideAbout/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2016/08/09/GlideAbout/" class="leancloud_visitors" data-flag-title="图片加载库Glide介绍">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>英文原文 <a href="https://inthecheesefactory.com/blog/get-to-know-glide-recommended-by-google/en" target="_blank" rel="external">Introduction to Glide, Image Loader Library for Android, recommended by Google</a><br>摘录来自：<a href="http://jcodecraeer.com/a/anzhuokaifa/androidkaifa/2015/0327/2650.html" target="_blank" rel="external">Google推荐的图片加载库Glide介绍</a>  </p>
</blockquote>
<p>在泰国举行的谷歌开发者论坛上，谷歌为我们介绍了一个名叫 Glide 的图片加载库，作者是bumptech。这个库被广泛的运用在google的开源项目中，包括2014年google I/O大会上发布的官方app。<br>它的成功让我非常感兴趣。我花了一整晚的时间把玩，决定分享一些自己的经验。在开始之前我想说，Glide和Picasso有90%的相似度，准确的说，就是Picasso的克隆版本。但是在细节上还是有不少区别的。  </p>
<h2 id="导入库"><a href="#导入库" class="headerlink" title="导入库"></a>导入库</h2><p>Picasso和Glide都在jcenter上。在项目中添加依赖非常简单：</p>
<h3 id="Picasso"><a href="#Picasso" class="headerlink" title="Picasso"></a>Picasso</h3><pre><code>dependencies {  
    compile &apos;com.squareup.picasso:picasso:2.5.1&apos;  
}  
</code></pre><h3 id="Glide"><a href="#Glide" class="headerlink" title="Glide"></a>Glide</h3><pre><code>dependencies {  
    compile &apos;com.github.bumptech.glide:glide:3.5.2&apos;  
    compile &apos;com.android.support:support-v4:22.0.0&apos;  
}  
</code></pre><p>Glide需要依赖Support Library v4，别忘了。其实Support Library v4已经是应用程序的标配了，这不是什么问题。  </p>
<h2 id="基础"><a href="#基础" class="headerlink" title="基础"></a>基础</h2><p>就如我所说的Glide和Picasso非常相似，Glide加载图片的方法和Picasso如出一辙。  </p>
<h3 id="Picasso-1"><a href="#Picasso-1" class="headerlink" title="Picasso"></a>Picasso</h3><pre><code>Picasso.with(context)  
    .load(&quot;http://inthecheesefactory.com/uploads/source/glidepicasso/cover.jpg&quot;)  
    .into(ivImg);  
</code></pre><h3 id="Glide-1"><a href="#Glide-1" class="headerlink" title="Glide"></a>Glide</h3><pre><code>Glide.with(context)  
    .load(&quot;http://inthecheesefactory.com/uploads/source/glidepicasso/cover.jpg&quot;)  
    .into(ivImg);  
</code></pre><p>虽然两者看起来一样，但是Glide更易用，因为Glide的with方法不光接受Context，还接受Activity 和 Fragment，Context会自动的从他们获取。<br><img src="http://obbu6r1mi.bkt.clouddn.com/glide1.png" alt=""><br>同时将Activity/Fragment作为with()参数的好处是：图片加载会和Activity/Fragment的生命周期保持一致，比如Paused状态在暂停加载，在Resumed的时候又自动重新加载。所以我建议传参的时候传递Activity 和 Fragment给Glide，而不是Context。  </p>
<h3 id="默认Bitmap格式是RGB-565"><a href="#默认Bitmap格式是RGB-565" class="headerlink" title="默认Bitmap格式是RGB_565"></a>默认Bitmap格式是RGB_565</h3><p>下面是加载图片时和Picasso的比较（1920x1080 像素的图片加载到768x432的ImageView中）<br><img src="http://obbu6r1mi.bkt.clouddn.com/glide2.jpg" alt=""><br>可以看到Glide加载的图片质量要差于Picasso（ps：我看不出来哈），为什么？这是因为Glide默认的Bitmap格式是RGB_565 ，比ARGB_8888格式的内存开销要小一半。下面是Picasso在ARGB8888下与Glide在RGB565下的内存开销图（应用自身占用了8m，因此以8为基准线比较）：<br><img src="http://obbu6r1mi.bkt.clouddn.com/glide3.png" alt=""><br>如果你对默认的RGB_565效果还比较满意，可以不做任何事，但是如果你觉得难以接受，可以创建一个新的GlideModule将Bitmap格式转换到ARGB_8888：  </p>
<pre><code>public class GlideConfiguration implements GlideModule {  

    @Override  
    public void applyOptions(Context context, GlideBuilder builder) {  
        // Apply options to the builder here.  
        builder.setDecodeFormat(DecodeFormat.PREFER_ARGB_8888);  
    }  

    @Override  
    public void registerComponents(Context context, Glide glide) {  
        // register ModelLoaders here.  
    }  
}  
</code></pre><p>同时在AndroidManifest.xml中将GlideModule定义为meta-data  </p>
<pre><code>&lt;meta-data  
    android:name=&quot;com.inthecheesefactory.lab.glidepicasso.GlideConfiguration&quot;  
    android:value=&quot;GlideModule&quot;/&gt;  
</code></pre><hr>
<p></p><p style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px"><img class="width-100percent" src="http://jcodecraeer.com/uploads/20150327/1427445294447874.jpg" alt="quality2" style="border:none; max-width:100%"></p><p style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px">这样看起来就会好很多。</p><p style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px">我们再来看看内存开销图，这次貌似Glide花费了两倍于上次的内存，但是Picasso的内存开销仍然远大于Glide。</p><p style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px"><img class="width-100percent" src="http://jcodecraeer.com/uploads/20150327/1427445294918728.png" alt="ram2_1" style="border:none; max-width:100%"></p><p style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px">原因在于Picasso是加载了全尺寸的图片到内存，然后让GPU来实时重绘大小。而Glide加载的大小和ImageView的大小是一致的，因此更小。当然，Picasso也可以指定加载的图片大小的：</p><pre class="js" style="white-space:pre-wrap; word-wrap:break-word; color:rgb(51,51,51); font-size:14px; line-height:26px; background-color:rgb(255,255,255)" name="code">Picasso.with(this)<br>    .load(“<a href="http://nuuneoi.com/uploads/source/playstore/cover.jpg" target="_blank" rel="external">http://nuuneoi.com/uploads/source/playstore/cover.jpg</a>“)<br>    .resize(768, 432)<br>    .into(ivImgPicasso);</pre><p style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px">但是问题在于你需要主动计算ImageView的大小，或者说你的ImageView大小是具体的值（而不是wrap_content），你也可以这样：</p><pre class="js" style="white-space:pre-wrap; word-wrap:break-word; color:rgb(51,51,51); font-size:14px; line-height:26px; background-color:rgb(255,255,255)" name="code">Picasso.with(this)<br>    .load(“<a href="http://nuuneoi.com/uploads/source/playstore/cover.jpg" target="_blank" rel="external">http://nuuneoi.com/uploads/source/playstore/cover.jpg</a>“)<br>    .fit()<br>    .centerCrop()<br>    .into(ivImgPicasso);</pre><p style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px">现在Picasso的内存开销就和Glide差不多了。</p><p style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px"><img class="width-100percent" src="http://jcodecraeer.com/uploads/20150327/1427445294433243.png" alt="memory3" style="border:none; max-width:100%"></p><p style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px">虽然内存开销差距不到，但是在这个问题上Glide完胜Picasso。因为Glide可以自动计算出任意情况下的ImageView大小。</p><h2 style="margin:0px; padding:0px; color:rgb(51,51,51); font-family:Arial; line-height:26px"><a name="t3"></a><span class="section-heading">Image质量的细节</span></h2><p style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px">这是将ImageView还原到真实大小时的比较。</p><p style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px"><img class="width-100percent" src="http://jcodecraeer.com/uploads/20150327/1427445294704430.png" alt="quality3" style="border:none; max-width:100%"></p><p style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px">你可以看到，Glide加载的图片没有Picasso那么平滑，我还没有找到一个可以直观改变图片大小调整算法的方法。</p><p style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px">但是这并不算什么坏事，因为很难察觉。</p><p style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px"><br></p><h2 style="margin:0px; padding:0px; color:rgb(51,51,51); font-family:Arial; line-height:26px"><a name="t4"></a>磁盘缓存</h2><p style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px">Picasso和Glide在磁盘缓存策略上有很大的不同。Picasso缓存的是全尺寸的，而Glide缓存的是跟ImageView尺寸相同的。</p><p style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px"><br></p><p style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px"><img class="width-100percent" src="http://jcodecraeer.com/uploads/20150327/1427445294110987.jpg" alt="cache" style="border:none; max-width:100%"></p><p style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px">上面提到的平滑度的问题依然存在，而且如果加载的是RGB565图片，那么缓存中的图片也是RGB565。</p><p style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px"> </p><p style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px">我尝试将ImageView调整成不同大小，但不管大小如何Picasso只缓存一个全尺寸的。Glide则不同，它会为每种大小的ImageView缓存一次。尽管一张图片已经缓存了一次，但是假如你要在另外一个地方再次以不同尺寸显示，需要重新下载，调整成新尺寸的大小，然后将这个尺寸的也缓存起来。</p><p style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px">具体说来就是：假如在第一个页面有一个200x200的ImageView，在第二个页面有一个100x100的ImageView，这两个ImageView本来是要显示同一张图片，却需要下载两次。</p><p style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px">不过，你可以改变这种行为，让<span style="color:rgb(41,128,185)">Glide</span>既缓存全尺寸又缓存其他尺寸：</p><pre class="js" style="white-space:pre-wrap; word-wrap:break-word; color:rgb(51,51,51); font-size:14px; line-height:26px; background-color:rgb(255,255,255)" name="code">Glide.with(this)<br>     .load(“<a href="http://nuuneoi.com/uploads/source/playstore/cover.jpg" target="_blank" rel="external">http://nuuneoi.com/uploads/source/playstore/cover.jpg</a>“)<br>     .diskCacheStrategy(DiskCacheStrategy.ALL)<br>     .into(ivImgGlide);</pre><p style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px">下次在任何ImageView中加载图片的时候，全尺寸的图片将从缓存中取出，重新调整大小，然后缓存。</p><p style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px">Glide的这种方式优点是加载显示非常快。而Picasso的方式则因为需要在显示之前重新调整大小而导致一些延迟，即便你添加了这段代码来让其立即显示：</p><pre class="js" style="white-space:pre-wrap; word-wrap:break-word; color:rgb(51,51,51); font-size:14px; line-height:26px; background-color:rgb(255,255,255)" name="code">//Picasso.noFade();</pre><p style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px"><img src="http://jcodecraeer.com/uploads/allimg/150327/163Aa632-0.gif" alt="loading3" style="border:none; max-width:100%; display:block; margin-left:auto; margin-right:auto"></p><p style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px"><br></p><p style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px">Picasso和Glide各有所长，你根据自己的需求选择合适的。</p><p style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px">对我而言，我更喜欢Glide，因为它远比Picasso快，虽然需要更大的空间来缓存。</p><br><p></p>
<p></p><h2 style="margin:0px; padding:0px; color:rgb(51,51,51); font-family:Arial; line-height:26px"><a name="t7"></a><span class="section-heading">特性<br></span></h2><p style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px">你可以做到几乎和Picasso一样多的事情，代码也几乎一样。</p><p style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px"><strong>Image Resizing</strong></p><pre class="js" style="white-space:pre-wrap; word-wrap:break-word; color:rgb(51,51,51); font-size:14px; line-height:26px; background-color:rgb(255,255,255)" name="code">// Picasso.resize(300, 200);<br>// Glide.override(300, 200);</pre><p style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px"><strong>Center Cropping</strong></p><pre class="js" style="white-space:pre-wrap; word-wrap:break-word; color:rgb(51,51,51); font-size:14px; line-height:26px; background-color:rgb(255,255,255)" name="code">// Picasso.centerCrop();<br>// Glide.centerCrop();</pre><p style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px"><strong>Transforming</strong></p><pre class="js" style="white-space:pre-wrap; word-wrap:break-word; color:rgb(51,51,51); font-size:14px; line-height:26px; background-color:rgb(255,255,255)" name="code">// Picasso.transform(new CircleTransform())<br>// Glide.transform(new CircleTransform(context))</pre><p style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px">设置占位图或者加载错误图：</p><pre class="js" style="white-space:pre-wrap; word-wrap:break-word; color:rgb(51,51,51); font-size:14px; line-height:26px; background-color:rgb(255,255,255)" name="code">// Picasso.placeholder(R.drawable.placeholder)<br>.error(R.drawable.imagenotfound)<br>// Glide.placeholder(R.drawable.placeholder)<br>.error(R.drawable.imagenotfound)</pre><p style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px">几乎和Picasso一样，从Picasso转换到Glide对你来说就是小菜一碟。</p><p style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px"><span class="section-heading"> </span></p><h2 style="margin:0px; padding:0px; color:rgb(51,51,51); font-family:Arial; line-height:26px"><a name="t8"></a><span class="section-heading">有什么Glide可以做而<span class="section-heading">Picasso</span>做不到</span></h2><p style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px">Glide可以加在GIF动态图，而Picasso不能。</p><p style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px"><img src="http://jcodecraeer.com/uploads/20150327/1427445366503084.gif" alt="gifanimation2" style="border:none; max-width:100%"></p><p style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px"><br></p><p style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px">同时因为Glide和Activity/Fragment的生命周期是一致的，因此gif的动画也会自动的随着Activity/Fragment的状态暂停、重放。Glide 的缓存在gif这里也是一样，调整大小然后缓存。<br></p><p style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px">但是从我的一次测试结果来看Glide 动画会消费太多的内存，因此谨慎使用。</p><p style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px">除了gif动画之外，Glide还可以将任何的本地视频解码成一张静态图片。</p><p style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px">还有一个特性是你可以配置图片显示的动画，而Picasso只有一种动画：fading in。</p><p style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px">最后一个是可以使用<code>thumbnail()产生一个你所加载图片的<span style="color:rgb(22,160,133)">thumbnail</span>。</code></p><p style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px"><code>其实还有一些特性，不过不是非常重要，比如将图像转换成字节数组等。</code></p><h2 style="margin:0px; padding:0px; color:rgb(51,51,51); font-family:Arial; line-height:26px"><a name="t9"></a><code>配置</code></h2><p style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px">有许多可以配置的选项，比如大小，缓存的磁盘位置，最大缓存空间，位图格式等等。可以在这个页面查看这些配置 <code><a target="_blank" href="https://github.com/bumptech/glide/wiki/Configuration" style="color:rgb(51,102,153); text-decoration:none">Configuration</a></code>。<br></p><h2 style="margin:0px; padding:0px; color:rgb(51,51,51); font-family:Arial; line-height:26px"><a name="t10"></a>库的大小</h2><p style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px">Picasso (v2.5.1)的大小约118kb，而Glide (v3.5.2)的大小约430kb。</p><p style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px"><img class="width-100percent" src="http://jcodecraeer.com/uploads/20150327/1427453389115686.png" alt="librarysize" style="border:none; max-width:100%"></p><p style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px">Anyway 312KB difference might not be that significant.</p><p style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px">不过312kb的差距并不是很重要。</p><p style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px">Picasso和Glide的方法个数分别是840和2678个。</p><p style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px"><img class="width-100percent" src="http://jcodecraeer.com/uploads/20150327/1427453390188737.png" alt="methodcount" style="border:none; max-width:100%"></p><p style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px">必须指出，对于DEX文件65535个方法的限制来说，2678是一个相当大的数字了。建议在使用Glide的时候开启ProGuard。</p><p style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px"><br></p><h2 style="margin:0px; padding:0px; color:rgb(51,51,51); font-family:Arial; line-height:26px"><a name="t11"></a><span class="section-heading">总结<br></span></h2><p style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px">Glide和Picasso都是非常完美的库。Glide加载图像以及磁盘缓存的方式都要优于Picasso，速度更快，并且Glide更有利于减少OutOfMemoryError的发生，GIF动画是Glide的杀手锏。不过Picasso的图片质量更高。你更喜欢哪个呢？</p><p style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px">虽然我使用了很长事件的Picasso，但是我得承认现在我更喜欢Glide。我的建议是使用Glide，但是将Bitmap格式换成 ARGB_8888、让Glide缓存同时缓存全尺寸和改变尺寸两种。</p><p style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px"> </p><h2 style="margin:0px; padding:0px; color:rgb(51,51,51); font-family:Arial; line-height:26px"><a name="t12"></a>相关资源</h2><p style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px">- <a target="_blank" href="http://google-opensource.blogspot.com/2014/09/glide-30-media-management-library-for.html" style="color:rgb(51,102,153); text-decoration:none">Glide 3.0: a media management library for Android</a></p><p style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px">- <a target="_blank" href="https://github.com/bumptech/glide/wiki" style="color:rgb(51,102,153); text-decoration:none">Glide Wiki</a></p><p style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px">- <a target="_blank" href="http://pluu.github.io/android%20study/2015/01/15/android-glide-picasso/" style="color:rgb(51,102,153); text-decoration:none">Android Picasso vs Glide</a></p><p style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px">- <a target="_blank" href="http://vardhan-justlikethat.blogspot.com/2014/09/android-image-loading-libraries-picasso.html" style="color:rgb(51,102,153); text-decoration:none">Android: Image loading libraries Picasso vs Glide</a></p><br>  <p></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/3/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/5/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/ocnyang.png"
               alt="OCN.Yang" />
          <p class="site-author-name" itemprop="name">OCN.Yang</p>
           
              <p class="site-description motion-element" itemprop="description">拼凑江山，只为遇见你时自己不那么不堪</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">47</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">9</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">36</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="http://www.jianshu.com/users/e61d05cbf47e/latest_articles" target="_blank" title="简书">
                  
                    <i class="fa fa-fw fa-pencil"></i>
                  
                  简书
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://github.com/ocnyang" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/shedoor" target="_blank" title="Weibo">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                  Weibo
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://love.shedoor.net/" target="_blank" title="Meet you">
                  
                    <i class="fa fa-fw fa-heartbeat"></i>
                  
                  Meet you
                </a>
              </span>
            
          
        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-inline">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              Links
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="http://www.shedoor.net/" title="个人" target="_blank">个人</a>
                </li>
              
            </ul>
          </div>
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2014 - 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">OCN.Yang</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      本站访客数
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      人次
    </span>
  

  
    <span class="site-pv">
      本站总访问量
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      次
    </span>
  
</div>


        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  






  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"ocnyang"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    
    <script src="/lib/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  
















  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("gh3omnCzhrHskUI74veM8V99-gzGzoHsz", "S5X90d5uKqp25VMacYGLwL60");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  

</body>
</html>
